<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY Indices Dashboard</title>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 12px;
        }
        
        select, input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        table th {
            background: #343a40;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
        }
        
        table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        #errorMsg {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 2px;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .tab:hover:not(.active) {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .company-config {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .company-config textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error-row {
            background-color: #f8d7da !important;
            color: #721c24;
        }
        
        .fallback-row {
            background-color: #d1ecf1 !important;
            color: #0c5460;
        }
        
        .live-row {
            background-color: #d4edda !important;
            color: #155724;
        }
        
        .demo-notice {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà NIFTY Indices Live Dashboard</h1>
            <p>Real-time Indian stock market indices with risk-reward analysis</p>
        </div>

        <div id="errorMsg">
            ‚ö†Ô∏è Unable to fetch live data. Showing fallback data instead.
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="refreshInterval">Refresh Interval:</label>
                <select id="refreshInterval">
                    <option value="30000">30 seconds</option>
                    <option value="60000" selected>1 minute</option>
                    <option value="300000">5 minutes</option>
                    <option value="600000">10 minutes</option>
                </select>
            </div>
            
            <div class="control-group">
                <div class="checkbox-container">
                    <input type="checkbox" id="autoRefreshToggle" checked>
                    <label for="autoRefreshToggle">Auto Refresh</label>
                </div>
            </div>
            
            <button class="refresh-btn" onclick="fetchAndRender()">üîÑ Refresh Now</button>
        </div>

        <div class="status">
            <div class="status-indicator"></div>
            <span>Live Data Feed Active</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('indices')">üìà Indices</div>
            <div class="tab" onclick="switchTab('companies')">üè¢ Companies</div>
        </div>

        <div id="indicesTab" class="tab-content active">

        <div class="section">
            <h2>üèÜ Top Market Indices</h2>
            <table id="topIndicesTable" class="display">
                <thead>
                    <tr>
                        <th>Index Name</th>
                        <th>Last Price</th>
                        <th>Change %</th>
                        <th>Year High</th>
                        <th>Year Low</th>
                        <th>Distance to High</th>
                        <th>Distance from Low</th>
                        <th>Risk/Reward</th>
                        <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <h2>üè≠ Sector Indices</h2>
            <table id="sectorIndicesTable" class="display">
                <thead>
                    <tr>
                        <th>Index Name</th>
                        <th>Last Price</th>
                        <th>Change %</th>
                        <th>Year High</th>
                        <th>Year Low</th>
                        <th>Distance to High</th>
                        <th>Distance from Low</th>
                        <th>Risk/Reward</th>
                        <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section">
            <h2>üìä All Indices</h2>
            <div class="controls">
                <div class="control-group">
                    <label for="indexTypeFilter">Index Type:</label>
                    <select id="indexTypeFilter">
                        <option value="all">All Types</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="indexSubTypeFilter">Index Sub-Type:</label>
                    <select id="indexSubTypeFilter">
                        <option value="all">All Sub-Types</option>
                    </select>
                </div>
            </div>
            <table id="allIndicesTable" class="display">
                <thead>
                    <tr>
                        <th>Index Name</th>
                        <th>Last Price</th>
                        <th>Change %</th>
                        <th>Year High</th>
                        <th>Year Low</th>
                        <th>Distance to High</th>
                        <th>Distance from Low</th>
                        <th>Risk/Reward</th>
                        <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        </div> <!-- Close indicesTab -->

        <div id="companiesTab" class="tab-content">
            <div class="company-config">
                <h3>Company Configuration</h3>
                <p>Add or remove companies from the list below (JSON format):</p>
                <textarea id="companiesConfig" placeholder='["TCS", "RELIANCE", "HDFCBANK", "INFY", "HINDUNILVR", "ICICIBANK", "SBIN", "BHARTIARTL", "ITC", "KOTAKBANK"]'>["TCS", "RELIANCE", "HDFCBANK", "INFY", "HINDUNILVR", "ICICIBANK", "SBIN", "BHARTIARTL", "ITC", "KOTAKBANK", "LT", "ASIANPAINT", "AXISBANK", "MARUTI", "SUNPHARMA", "TITAN", "ULTRACEMCO", "NESTLEIND", "BAJFINANCE", "POWERGRID"]</textarea>
                <br><br>
                <button class="refresh-btn" onclick="loadCompaniesData()">üîÑ Load Live Data</button>
                <button class="refresh-btn" onclick="loadDemoCompaniesData()" style="background: #28a745;">üìä Load Demo Data</button>
                <button class="refresh-btn" onclick="saveCompaniesConfig()" style="background: #6c757d;">üíæ Save Config</button>
                <button class="refresh-btn" onclick="testCompaniesData()" style="background: #17a2b8;">üß™ Test Function</button>
                <button class="refresh-btn" onclick="clearDemoData()" style="background: #dc3545;">üóëÔ∏è Clear Demo Data</button>
                <button class="refresh-btn" onclick="testNSEAPI()" style="background: #20c997;">üß™ Test Vercel API (RELIANCE)</button>
                <button class="refresh-btn" onclick="testCORSSolutions()" style="background: #fd7e14;">üîß Test CORS Solutions</button>
                <button class="refresh-btn" onclick="checkCORSStatus()" style="background: #6610f2;">‚ö° Quick CORS Check</button>
                <button class="refresh-btn" onclick="runComprehensiveDiagnostics()" style="background: #e83e8c;">üîç Full Diagnostics</button>
                <button class="refresh-btn" onclick="openNSEWebsite()" style="background: #17a2b8;">üç™ Get NSE Session</button>
                <button class="refresh-btn" onclick="testSessionCookies()" style="background: #28a745;">‚úÖ Test Session</button>
                <br><br>
                <div class="checkbox-container">
                    <input type="checkbox" id="autoLoadLiveData">
                    <label for="autoLoadLiveData">üî¥ Auto-load Live Data on startup (experimental)</label>
                </div>
                <br>
                <div style="background: #e2e3e5; padding: 8px; border-radius: 4px; font-size: 12px;">
                    <strong>üîó Quick Links for CORS Extensions:</strong><br>
                    ‚Ä¢ Chrome: Search "CORS Unblock" in Chrome Web Store<br>
                    ‚Ä¢ Firefox: Search "CORS Everywhere" in Firefox Add-ons<br>
                    ‚Ä¢ Edge: Search "CORS" in Microsoft Edge Add-ons
                </div>
                <br><br>
                <div id="companiesStatus" style="background: #d1ecf1; padding: 10px; border-radius: 5px; border: 1px solid #bee5eb; margin-bottom: 10px;">
                    <strong>Status:</strong> <span id="companiesStatusText">Ready to load data</span>
                </div>
                <div style="background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb; margin-bottom: 10px;">
                    <strong>üöÄ Vercel API Proxy Ready!</strong><br>
                    This version uses Vercel serverless functions to proxy NSE API calls, completely eliminating CORS issues. No browser extensions needed!<br><br>
                    <strong>Ready to use:</strong> Click "üîÑ Load Live Data" to fetch real-time NSE data through the Vercel proxy.
                </div>
                
                <div style="background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb;">
                    <strong>‚úÖ CORS Solutions (Choose One):</strong><br>
                    
                    <strong>üîß Browser Extension (Easiest):</strong><br>
                    ‚Ä¢ Install "CORS Unblock" or "CORS Everywhere" browser extension<br>
                    ‚Ä¢ Enable it and refresh this page<br>
                    ‚Ä¢ Direct NSE API calls will now work<br><br>
                    
                    <strong>üç™ Session Cookie Method (Recommended):</strong><br>
                    ‚Ä¢ Click "üç™ Get NSE Session" to visit NSE website<br>
                    ‚Ä¢ Wait for NSE website to fully load<br>
                    ‚Ä¢ Return here and click "‚úÖ Test Session" to verify<br>
                    ‚Ä¢ Then try "üîÑ Load Live Data" for real data<br><br>
                    
                    <strong>üåê Use CORS Proxies (Current Method):</strong><br>
                    ‚Ä¢ System automatically tries proxy services<br>
                    ‚Ä¢ Click "üîß Test CORS Solutions" to see which work<br>
                    ‚Ä¢ May be slower than direct API<br><br>
                    
                    <strong>üñ•Ô∏è Server Deployment:</strong><br>
                    ‚Ä¢ Deploy to web server (not file:// or localhost)<br>
                    ‚Ä¢ Create backend API proxy<br>
                    ‚Ä¢ Most reliable solution for production
                </div>
            </div>
            
            <div id="companiesLoading" class="loading" style="display: none;">
                <div>Loading company data... <span id="loadingProgress">0/0</span></div>
            </div>
            
            <div class="section">
                <h2>üè¢ Companies Data</h2>
                <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                    <strong>Data Sources:</strong> 
                    üöÄ Live via Vercel Proxy | üü¢ Live NSE Data | üåê Live via External Proxy | üìä Demo Data | ‚ùå Error/Missing
                </div>
                <table id="companiesTable" class="display">
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>Symbol</th>
                            <th>Last Price</th>
                            <th>Change %</th>
                            <th>Year High</th>
                            <th>Year Low</th>
                            <th>Distance to High</th>
                            <th>Distance from Low</th>
                            <th>Risk/Reward</th>
                            <th>Volume</th>
                            <th>Market Cap</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        const fallbackData = [
            {
                indexName: "NIFTY 50",
                last: "22,000",
                yearHigh: "23,000",
                yearLow: "17,000",
                percChange: "0.35",
                indexType: "Broad Market",
                indexSubType: "Large Cap",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY BANK",
                last: "47,000",
                yearHigh: "48,000",
                yearLow: "38,000",
                percChange: "0.50",
                indexType: "Sectoral",
                indexSubType: "Banking",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY IT",
                last: "35,000",
                yearHigh: "36,000",
                yearLow: "28,000",
                percChange: "-0.25",
                indexType: "Sectoral",
                indexSubType: "Information Technology",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY AUTO",
                last: "18,500",
                yearHigh: "19,000",
                yearLow: "15,000",
                percChange: "0.75",
                indexType: "Sectoral",
                indexSubType: "Automobile",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY NEXT 50",
                last: "65,000",
                yearHigh: "68,000",
                yearLow: "52,000",
                percChange: "0.45",
                indexType: "Broad Market",
                indexSubType: "Large Cap",
                timeVal: new Date().toLocaleString()
            }
        ];

        // Company data storage
        let companiesData = [];
        let companiesConfig = ["TCS", "RELIANCE", "HDFCBANK", "INFY", "HINDUNILVR", "ICICIBANK", "SBIN", "BHARTIARTL", "ITC", "KOTAKBANK", "LT", "ASIANPAINT", "AXISBANK", "MARUTI", "SUNPHARMA", "TITAN", "ULTRACEMCO", "NESTLEIND", "BAJFINANCE", "POWERGRID"];

        // Load companies config from textarea
        function loadCompaniesConfig() {
            try {
                const configText = document.getElementById('companiesConfig').value;
                companiesConfig = JSON.parse(configText);
                return true;
            } catch (e) {
                alert('Invalid JSON format in companies configuration');
                return false;
            }
        }

        // Save companies config
        function saveCompaniesConfig() {
            if (loadCompaniesConfig()) {
                alert('Companies configuration saved successfully!');
            }
        }

                 // Clear demo data and show only live data
        function clearDemoData() {
            updateCompaniesStatus("Clearing demo data...", true);
            companiesData = companiesData.filter(company => !company.fallback && !company.error);
            
            if (companiesData.length === 0) {
                updateCompaniesStatus("No live data available. All data was demo/fallback.", false);
                // Clear the table
                const table = $('#companiesTable');
                if ($.fn.dataTable.isDataTable(table)) {
                    table.DataTable().destroy();
                }
                table.find('tbody')[0].innerHTML = '<tr><td colspan="12" style="text-align: center; padding: 20px; color: #666;">No live data available. Click "Load Live Data" to fetch real data.</td></tr>';
            } else {
                renderCompaniesTable();
                updateCompaniesStatus(`Showing ${companiesData.length} companies with live data only`, true);
            }
        }

        // Test Vercel API proxy with RELIANCE
        async function testNSEAPI() {
            updateCompaniesStatus("Testing Vercel API proxy with RELIANCE...", true);
            console.log("=== VERCEL API PROXY TEST ===");
            
            try {
                const testData = await fetchCompanyData('RELIANCE');
                console.log("Vercel API Test Result:", testData);
                
                if (testData.isLive) {
                    updateCompaniesStatus(`‚úÖ Vercel API Success! Got live data for RELIANCE (‚Çπ${testData.lastPrice})`, true);
                    
                    // Add test result to table
                    const existingIndex = companiesData.findIndex(c => c.symbol === 'RELIANCE');
                    if (existingIndex >= 0) {
                        companiesData[existingIndex] = testData;
                    } else {
                        companiesData.unshift(testData);
                    }
                    renderCompaniesTable();
                } else if (testData.fallback) {
                    updateCompaniesStatus("‚ö†Ô∏è Vercel API failed, using demo data for RELIANCE", false);
                } else {
                    updateCompaniesStatus("‚ùå Vercel API test failed completely", false);
                }
            } catch (error) {
                console.error("Vercel API Test Error:", error);
                updateCompaniesStatus(`‚ùå Vercel API Error: ${error.message}`, false);
            }
        }

        // Test different CORS solutions
        async function testCORSSolutions() {
            updateCompaniesStatus("Testing CORS solutions...", true);
            console.log("=== CORS SOLUTIONS TEST ===");
            
            const corsTests = [
                {
                    name: "Direct NSE API",
                    url: "https://www.nseindia.com/api/quote-equity?symbol=RELIANCE",
                    expectedResult: "Will fail due to CORS policy"
                },
                {
                    name: "AllOrigins Proxy",
                    url: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://www.nseindia.com/api/quote-equity?symbol=RELIANCE"),
                    expectedResult: "Should work if proxy is online"
                },
                {
                    name: "CORS.io Proxy",
                    url: "https://corsproxy.io/?https://www.nseindia.com/api/quote-equity?symbol=RELIANCE",
                    expectedResult: "Alternative proxy service"
                }
            ];
            
            let results = [];
            
            for (let test of corsTests) {
                try {
                    console.log(`Testing: ${test.name}`);
                    updateCompaniesStatus(`Testing ${test.name}...`, true);
                    
                    const response = await fetch(test.url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`‚úÖ ${test.name} SUCCESS:`, data);
                        results.push(`‚úÖ ${test.name}: SUCCESS`);
                    } else {
                        console.log(`‚ùå ${test.name} FAILED: HTTP ${response.status}`);
                        results.push(`‚ùå ${test.name}: HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log(`‚ùå ${test.name} ERROR:`, error.message);
                    results.push(`‚ùå ${test.name}: ${error.message.substring(0, 50)}...`);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            updateCompaniesStatus(`CORS Test Results: ${results.join(' | ')}`, results.some(r => r.includes('SUCCESS')));
            
            // Show detailed results in console
            console.log("=== CORS TEST SUMMARY ===");
            results.forEach(result => console.log(result));
        }

        // Quick CORS status check
        async function checkCORSStatus() {
            updateCompaniesStatus("Checking CORS status...", true);
            
            try {
                // Quick test with a simple NSE API call
                const response = await fetch('https://www.nseindia.com/api/quote-equity?symbol=RELIANCE', {
                    method: 'HEAD', // Lighter request
                    mode: 'cors'
                });
                
                if (response.ok) {
                    updateCompaniesStatus("‚úÖ CORS is working! Direct NSE API access enabled.", true);
                    console.log("‚úÖ CORS Check: Direct API access is working");
                } else {
                    updateCompaniesStatus(`‚ö†Ô∏è CORS enabled but API returned HTTP ${response.status}`, false);
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    updateCompaniesStatus("‚ùå CORS is blocked. Install browser extension or use proxies.", false);
                    console.log("‚ùå CORS Check: Blocked by CORS policy");
                } else {
                    updateCompaniesStatus(`‚ùå Network error: ${error.message.substring(0, 50)}...`, false);
                    console.log("‚ùå CORS Check: Network error", error);
                }
            }
        }

        // Test function for debugging
        function testCompaniesData() {
            console.log("=== COMPANIES DEBUG TEST ===");
            console.log("companiesData length:", companiesData.length);
            console.log("companiesConfig:", companiesConfig);
            console.log("Table element exists:", $('#companiesTable').length > 0);
            console.log("Table body exists:", $('#companiesTable tbody').length > 0);
            console.log("Current tab:", document.querySelector('.tab-content.active')?.id || 'none');
            
            updateCompaniesStatus("Running diagnostics...", true);
            
            if (companiesData.length === 0) {
                console.log("No companies data found, loading demo data...");
                updateCompaniesStatus("No data found, loading demo data...", true);
                loadDemoCompaniesData();
            } else {
                console.log("Companies data exists, re-rendering table...");
                updateCompaniesStatus("Refreshing table display...", true);
                renderCompaniesTable();
            }
            
            // Show diagnostic results
            setTimeout(() => {
                const diagnostics = [
                    `Data: ${companiesData.length} companies`,
                    `Table: ${$('#companiesTable').length > 0 ? 'Found' : 'Missing'}`,
                    `Tab: ${document.querySelector('.tab-content.active')?.id || 'Unknown'}`
                ].join(' | ');
                updateCompaniesStatus(`Diagnostics: ${diagnostics}`, true);
            }, 1000);
        }

        // Comprehensive diagnostic function
        async function runComprehensiveDiagnostics() {
            console.log("=== COMPREHENSIVE DIAGNOSTICS ===");
            updateCompaniesStatus("Running comprehensive diagnostics...", true);
            
            const results = {
                browserInfo: {},
                corsPlugin: {},
                nseApiTest: {},
                proxies: {},
                recommendations: []
            };
            
            // 1. Browser Information
            console.log("1. Browser Information:");
            results.browserInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                protocol: location.protocol,
                hostname: location.hostname,
                port: location.port || 'default'
            };
            console.log("Browser Info:", results.browserInfo);
            
            // 2. CORS Plugin Test
            console.log("\n2. CORS Plugin Test:");
            try {
                const corsTestUrl = 'https://httpbin.org/headers';
                const corsResponse = await fetch(corsTestUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (corsResponse.ok) {
                    const corsData = await corsResponse.json();
                    results.corsPlugin = {
                        working: true,
                        headers: corsData.headers,
                        message: "CORS plugin appears to be working"
                    };
                    console.log("‚úÖ CORS Plugin Test: PASSED");
                } else {
                    results.corsPlugin = {
                        working: false,
                        status: corsResponse.status,
                        message: `CORS test failed with status ${corsResponse.status}`
                    };
                    console.log("‚ùå CORS Plugin Test: FAILED");
                }
            } catch (corsError) {
                results.corsPlugin = {
                    working: false,
                    error: corsError.message,
                    message: "CORS plugin may not be working properly"
                };
                console.log("‚ùå CORS Plugin Test: ERROR", corsError.message);
            }
            
            // 3. NSE API Direct Test
            console.log("\n3. NSE API Direct Test:");
            try {
                const nseUrl = 'https://www.nseindia.com/api/quote-equity?symbol=RELIANCE';
                const nseResponse = await fetch(nseUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Referer': 'https://www.nseindia.com/',
                        'Origin': 'https://www.nseindia.com'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log("NSE Response Status:", nseResponse.status);
                console.log("NSE Response Headers:", [...nseResponse.headers.entries()]);
                
                if (nseResponse.ok) {
                    const nseData = await nseResponse.json();
                    results.nseApiTest = {
                        working: true,
                        status: nseResponse.status,
                        hasData: !!(nseData.info || nseData.priceInfo),
                        dataStructure: Object.keys(nseData),
                        message: "NSE API direct access working!"
                    };
                    console.log("‚úÖ NSE API Direct Test: SUCCESS", nseData);
                } else {
                    const responseText = await nseResponse.text();
                    results.nseApiTest = {
                        working: false,
                        status: nseResponse.status,
                        statusText: nseResponse.statusText,
                        responseText: responseText.substring(0, 200),
                        message: `NSE API returned ${nseResponse.status}: ${nseResponse.statusText}`
                    };
                    console.log("‚ùå NSE API Direct Test: HTTP ERROR", nseResponse.status, responseText);
                }
            } catch (nseError) {
                results.nseApiTest = {
                    working: false,
                    error: nseError.message,
                    errorType: nseError.name,
                    message: "NSE API direct access failed"
                };
                console.log("‚ùå NSE API Direct Test: EXCEPTION", nseError);
            }
            
            // 4. Proxy Services Test
            console.log("\n4. Proxy Services Test:");
            const proxyServices = [
                {
                    name: 'AllOrigins',
                    url: 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.nseindia.com/api/quote-equity?symbol=RELIANCE')
                },
                {
                    name: 'CORS.io',
                    url: 'https://corsproxy.io/?https://www.nseindia.com/api/quote-equity?symbol=RELIANCE'
                },
                {
                    name: 'CodeTabs',
                    url: 'https://api.codetabs.com/v1/proxy?quest=https://www.nseindia.com/api/quote-equity?symbol=RELIANCE'
                }
            ];
            
            results.proxies = {};
            
            for (const proxy of proxyServices) {
                try {
                    console.log(`Testing ${proxy.name}...`);
                    const proxyResponse = await fetch(proxy.url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (proxyResponse.ok) {
                        const proxyData = await proxyResponse.json();
                        results.proxies[proxy.name] = {
                            working: true,
                            status: proxyResponse.status,
                            hasData: !!(proxyData.contents || proxyData.info || proxyData.priceInfo),
                            message: "Proxy service working"
                        };
                        console.log(`‚úÖ ${proxy.name}: SUCCESS`);
                    } else {
                        results.proxies[proxy.name] = {
                            working: false,
                            status: proxyResponse.status,
                            message: `HTTP ${proxyResponse.status}`
                        };
                        console.log(`‚ùå ${proxy.name}: HTTP ${proxyResponse.status}`);
                    }
                } catch (proxyError) {
                    results.proxies[proxy.name] = {
                        working: false,
                        error: proxyError.message,
                        message: "Proxy service failed"
                    };
                    console.log(`‚ùå ${proxy.name}: ERROR`, proxyError.message);
                }
            }
            
            // 5. Generate Recommendations
            console.log("\n5. Generating Recommendations:");
            
            if (results.nseApiTest.working) {
                results.recommendations.push("‚úÖ NSE API is working directly! Your CORS plugin is properly configured.");
            } else if (results.corsPlugin.working && !results.nseApiTest.working) {
                results.recommendations.push("‚ö†Ô∏è CORS plugin is working but NSE API is blocked. NSE may have additional anti-bot measures.");
                results.recommendations.push("üí° Try: 1) Different User-Agent, 2) Visit nseindia.com first to get session cookies, 3) Try different CORS plugin");
            } else if (!results.corsPlugin.working) {
                results.recommendations.push("‚ùå CORS plugin doesn't seem to be working properly.");
                results.recommendations.push("üí° Try: 1) Restart browser, 2) Check plugin settings, 3) Try different CORS extension");
            }
            
            const workingProxies = Object.values(results.proxies).filter(p => p.working).length;
            if (workingProxies > 0) {
                results.recommendations.push(`‚úÖ ${workingProxies} proxy service(s) are working as fallback.`);
            } else {
                results.recommendations.push("‚ùå No proxy services are working. Network may be restricted.");
            }
            
            // Display Results
            console.log("\n=== DIAGNOSTIC RESULTS ===");
            console.log("Full Results:", results);
            
            const summary = [
                `Browser: ${results.browserInfo.userAgent.split(' ')[0]}`,
                `CORS Plugin: ${results.corsPlugin.working ? '‚úÖ Working' : '‚ùå Not Working'}`,
                `NSE Direct: ${results.nseApiTest.working ? '‚úÖ Working' : '‚ùå Blocked'}`,
                `Proxies: ${workingProxies}/${proxyServices.length} working`
            ].join(' | ');
            
            updateCompaniesStatus(`Diagnostics Complete: ${summary}`, results.nseApiTest.working || workingProxies > 0);
            
            // Show recommendations
            if (results.recommendations.length > 0) {
                console.log("\n=== RECOMMENDATIONS ===");
                results.recommendations.forEach(rec => console.log(rec));
                
                // Also show in UI
                alert("Diagnostic Results:\n\n" + results.recommendations.join('\n\n') + "\n\nCheck browser console for detailed results.");
            }
            
            return results;
        }

        // Open NSE website to get session cookies
        function openNSEWebsite() {
            updateCompaniesStatus("Opening NSE website to get session cookies...", true);
            
            // Open NSE website in new tab
            const nseWindow = window.open('https://www.nseindia.com', '_blank');
            
            if (nseWindow) {
                // Show instructions
                alert("NSE website opened in new tab.\n\n" +
                      "Steps:\n" +
                      "1. Wait for NSE website to fully load\n" +
                      "2. Browse around a bit (optional)\n" +
                      "3. Close that tab and return here\n" +
                      "4. Click 'üîÑ Load Live Data' to test\n\n" +
                      "This helps NSE API recognize your browser as legitimate.");
                
                updateCompaniesStatus("NSE website opened. Follow instructions and return here to test API.", true);
            } else {
                alert("Popup blocked! Please allow popups for this site or manually visit:\nhttps://www.nseindia.com");
                updateCompaniesStatus("Popup blocked. Please manually visit NSE website.", false);
            }
        }

        // Test if session cookies are working
        async function testSessionCookies() {
            updateCompaniesStatus("Testing NSE session cookies...", true);
            console.log("=== NSE SESSION TEST ===");
            
            try {
                // Test with a simple NSE API call
                const response = await fetch('https://www.nseindia.com/api/allIndices', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Referer': 'https://www.nseindia.com/',
                        'Origin': 'https://www.nseindia.com'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log("Session Test Response Status:", response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log("‚úÖ Session cookies working! API response:", data);
                    updateCompaniesStatus("‚úÖ Session cookies working! NSE API is accessible.", true);
                    
                    // Show success message
                    alert("‚úÖ Success! Session cookies are working.\n\nNSE API is now accessible. You can load live company data.");
                } else if (response.status === 401) {
                    console.log("‚ùå Still getting 401 - session cookies not established");
                    updateCompaniesStatus("‚ùå Still need session cookies. Visit NSE website first.", false);
                    
                    alert("‚ùå Session cookies not established yet.\n\nPlease:\n1. Visit NSE website (click 'üç™ Get NSE Session')\n2. Wait for it to fully load\n3. Return here and test again");
                } else {
                    console.log("‚ö†Ô∏è Unexpected response:", response.status);
                    updateCompaniesStatus(`‚ö†Ô∏è Unexpected response: ${response.status}`, false);
                }
            } catch (error) {
                console.error("Session test error:", error);
                updateCompaniesStatus(`‚ùå Session test failed: ${error.message}`, false);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            console.log("Switching to tab:", tabName);
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // If switching to companies tab and no data loaded, load demo data
            if (tabName === 'companies' && companiesData.length === 0) {
                console.log("Loading demo data for companies tab");
                loadDemoCompaniesData();
            }
        }

        // Fallback company data for demo
        const fallbackCompanyData = {
            "TCS": { companyName: "Tata Consultancy Services", lastPrice: 3580, pChange: 0.45, weekHigh52: 4100, weekLow52: 3000, totalTradedVolume: 1500000, marketCap: 130000000000 },
            "RELIANCE": { companyName: "Reliance Industries", lastPrice: 2850, pChange: -0.35, weekHigh52: 3100, weekLow52: 2200, totalTradedVolume: 2000000, marketCap: 190000000000 },
            "HDFCBANK": { companyName: "HDFC Bank", lastPrice: 1680, pChange: 0.25, weekHigh52: 1800, weekLow52: 1350, totalTradedVolume: 1800000, marketCap: 130000000000 },
            "INFY": { companyName: "Infosys", lastPrice: 1750, pChange: 0.15, weekHigh52: 1950, weekLow52: 1350, totalTradedVolume: 1200000, marketCap: 72000000000 },
            "HINDUNILVR": { companyName: "Hindustan Unilever", lastPrice: 2650, pChange: -0.12, weekHigh52: 2900, weekLow52: 2200, totalTradedVolume: 800000, marketCap: 62000000000 },
            "ICICIBANK": { companyName: "ICICI Bank", lastPrice: 1180, pChange: 0.38, weekHigh52: 1300, weekLow52: 900, totalTradedVolume: 2200000, marketCap: 82000000000 },
            "SBIN": { companyName: "State Bank of India", lastPrice: 820, pChange: 0.52, weekHigh52: 900, weekLow52: 550, totalTradedVolume: 3000000, marketCap: 73000000000 },
            "BHARTIARTL": { companyName: "Bharti Airtel", lastPrice: 1520, pChange: -0.28, weekHigh52: 1700, weekLow52: 1100, totalTradedVolume: 1600000, marketCap: 85000000000 },
            "ITC": { companyName: "ITC Limited", lastPrice: 480, pChange: 0.18, weekHigh52: 520, weekLow52: 380, totalTradedVolume: 2500000, marketCap: 60000000000 },
            "KOTAKBANK": { companyName: "Kotak Mahindra Bank", lastPrice: 1850, pChange: 0.22, weekHigh52: 2100, weekLow52: 1500, totalTradedVolume: 900000, marketCap: 36000000000 },
            "LT": { companyName: "Larsen & Toubro", lastPrice: 3650, pChange: 0.45, weekHigh52: 4000, weekLow52: 2800, totalTradedVolume: 700000, marketCap: 51000000000 },
            "ASIANPAINT": { companyName: "Asian Paints", lastPrice: 3200, pChange: -0.15, weekHigh52: 3700, weekLow52: 2800, totalTradedVolume: 600000, marketCap: 31000000000 },
            "AXISBANK": { companyName: "Axis Bank", lastPrice: 1150, pChange: 0.35, weekHigh52: 1350, weekLow52: 850, totalTradedVolume: 1800000, marketCap: 35000000000 },
            "MARUTI": { companyName: "Maruti Suzuki", lastPrice: 11500, pChange: 0.28, weekHigh52: 13000, weekLow52: 9500, totalTradedVolume: 400000, marketCap: 35000000000 },
            "SUNPHARMA": { companyName: "Sun Pharmaceutical", lastPrice: 1720, pChange: -0.18, weekHigh52: 1900, weekLow52: 1200, totalTradedVolume: 1100000, marketCap: 41000000000 },
            "TITAN": { companyName: "Titan Company", lastPrice: 3350, pChange: 0.42, weekHigh52: 3800, weekLow52: 2800, totalTradedVolume: 800000, marketCap: 30000000000 },
            "ULTRACEMCO": { companyName: "UltraTech Cement", lastPrice: 10200, pChange: 0.15, weekHigh52: 11500, weekLow52: 8500, totalTradedVolume: 200000, marketCap: 30000000000 },
            "NESTLEIND": { companyName: "Nestle India", lastPrice: 2450, pChange: -0.08, weekHigh52: 2800, weekLow52: 2100, totalTradedVolume: 300000, marketCap: 24000000000 },
            "BAJFINANCE": { companyName: "Bajaj Finance", lastPrice: 6800, pChange: 0.65, weekHigh52: 8000, weekLow52: 5200, totalTradedVolume: 600000, marketCap: 42000000000 },
            "POWERGRID": { companyName: "Power Grid Corp", lastPrice: 320, pChange: 0.25, weekHigh52: 380, weekLow52: 250, totalTradedVolume: 1500000, marketCap: 30000000000 }
        };

        // Fetch company data using Vercel API proxy (no CORS issues!)
        async function fetchCompanyData(symbol) {
            try {
                console.log(`Fetching data for ${symbol} via Vercel API proxy`);
                
                // Use Vercel API proxy endpoint
                const proxyUrl = `/api/nse-proxy?symbol=${symbol}&endpoint=quote`;
                
                try {
                    console.log(`üîÑ Trying Vercel API proxy for ${symbol}...`);
                    console.log('URL:', proxyUrl);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log(`Vercel API Response Status: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`‚úÖ Vercel API SUCCESS for ${symbol}:`, data);
                        
                        // Check if we have NSE data structure
                        if (data && (data.info || data.priceInfo)) {
                            const info = data.info || {};
                            const priceInfo = data.priceInfo || {};
                            
                            return {
                                symbol: symbol,
                                companyName: info.companyName || info.symbol || symbol,
                                lastPrice: priceInfo.lastPrice || 0,
                                change: priceInfo.change || 0,
                                pChange: priceInfo.pChange || 0,
                                dayHigh: priceInfo.intraDayHighLow?.max || priceInfo.dayHigh || 0,
                                dayLow: priceInfo.intraDayHighLow?.min || priceInfo.dayLow || 0,
                                weekHigh52: priceInfo.weekHighLow?.max || priceInfo.weekHigh52 || 0,
                                weekLow52: priceInfo.weekHighLow?.min || priceInfo.weekLow52 || 0,
                                totalTradedVolume: priceInfo.totalTradedVolume || 0,
                                marketCap: info.marketCap || 0,
                                lastUpdated: new Date().toLocaleString() + ' (üöÄ Live via Vercel)',
                                isLive: true
                            };
                        } else {
                            console.warn(`‚ö†Ô∏è Vercel API returned unexpected structure:`, data);
                            throw new Error('Invalid response structure from Vercel API');
                        }
                    } else {
                        const errorData = await response.json();
                        console.error(`‚ùå Vercel API failed with status ${response.status}:`, errorData);
                        
                        if (response.status === 401) {
                            console.log('üîê NSE API requires authentication (even through proxy)');
                            throw new Error(`NSE API authentication required: ${errorData.details || 'Session cookies needed'}`);
                        } else {
                            throw new Error(`Vercel API HTTP ${response.status}: ${errorData.error || 'Unknown error'}`);
                        }
                    }
                } catch (proxyError) {
                    console.error(`‚ùå Vercel API Error for ${symbol}:`, proxyError);
                    
                    // Fall back to external proxies if Vercel proxy fails
                    console.log(`üîÑ Trying external proxy services for ${symbol}...`);
                    
                    const externalProxies = [
                        {
                            name: 'AllOrigins',
                            url: `https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.nseindia.com/api/quote-equity?symbol=${symbol}`)}`,
                            parseResponse: (data) => JSON.parse(data.contents)
                        },
                        {
                            name: 'CORS.io',
                            url: `https://corsproxy.io/?https://www.nseindia.com/api/quote-equity?symbol=${symbol}`,
                            parseResponse: (data) => data
                        }
                    ];
                    
                    for (const proxy of externalProxies) {
                        try {
                            console.log(`üîÑ Trying ${proxy.name} proxy...`);
                            
                            const response = await fetch(proxy.url, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });
                            
                            if (response.ok) {
                                const rawData = await response.json();
                                const data = proxy.parseResponse(rawData);
                                console.log(`‚úÖ ${proxy.name} proxy SUCCESS:`, data);
                                
                                if (data && (data.info || data.priceInfo)) {
                                    const info = data.info || {};
                                    const priceInfo = data.priceInfo || {};
                                    
                                    return {
                                        symbol: symbol,
                                        companyName: info.companyName || info.symbol || symbol,
                                        lastPrice: priceInfo.lastPrice || 0,
                                        change: priceInfo.change || 0,
                                        pChange: priceInfo.pChange || 0,
                                        dayHigh: priceInfo.intraDayHighLow?.max || priceInfo.dayHigh || 0,
                                        dayLow: priceInfo.intraDayHighLow?.min || priceInfo.dayLow || 0,
                                        weekHigh52: priceInfo.weekHighLow?.max || priceInfo.weekHigh52 || 0,
                                        weekLow52: priceInfo.weekHighLow?.min || priceInfo.weekLow52 || 0,
                                        totalTradedVolume: priceInfo.totalTradedVolume || 0,
                                        marketCap: info.marketCap || 0,
                                        lastUpdated: new Date().toLocaleString() + ` (üåê Live via ${proxy.name})`,
                                        isLive: true
                                    };
                                }
                            } else {
                                console.warn(`‚ö†Ô∏è ${proxy.name} proxy failed: HTTP ${response.status}`);
                            }
                        } catch (externalProxyError) {
                            console.warn(`‚ö†Ô∏è ${proxy.name} proxy error:`, externalProxyError.message);
                        }
                    }
                    
                    throw proxyError;
                }
                
            } catch (error) {
                console.error(`‚ùå Complete failure for ${symbol}:`, error);
                
                // Use fallback data if available
                if (fallbackCompanyData[symbol]) {
                    const fallback = fallbackCompanyData[symbol];
                    return {
                        symbol: symbol,
                        companyName: fallback.companyName,
                        lastPrice: fallback.lastPrice,
                        change: 0,
                        pChange: fallback.pChange,
                        dayHigh: 0,
                        dayLow: 0,
                        weekHigh52: fallback.weekHigh52,
                        weekLow52: fallback.weekLow52,
                        totalTradedVolume: fallback.totalTradedVolume,
                        marketCap: fallback.marketCap,
                        lastUpdated: new Date().toLocaleString() + ' (üìä Demo Data)',
                        fallback: true
                    };
                }
                
                return {
                    symbol: symbol,
                    companyName: symbol,
                    lastPrice: 0,
                    change: 0,
                    pChange: 0,
                    dayHigh: 0,
                    dayLow: 0,
                    weekHigh52: 0,
                    weekLow52: 0,
                    totalTradedVolume: 0,
                    marketCap: 0,
                    lastUpdated: new Date().toLocaleString() + ' (‚ùå Error)',
                    error: true
                };
            }
        }

        // Load companies data
        async function loadCompaniesData() {
            if (!loadCompaniesConfig()) return;
            
            updateCompaniesStatus("Attempting to load live data...", true);
            
            const loadingDiv = document.getElementById('companiesLoading');
            const progressSpan = document.getElementById('loadingProgress');
            
            loadingDiv.style.display = 'block';
            companiesData = [];
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < companiesConfig.length; i++) {
                const symbol = companiesConfig[i];
                progressSpan.textContent = `${i + 1}/${companiesConfig.length}`;
                updateCompaniesStatus(`Loading live data... ${i + 1}/${companiesConfig.length} (${successCount} success, ${failCount} failed)`, true);
                
                const companyData = await fetchCompanyData(symbol);
                companiesData.push(companyData);
                
                if (companyData.error) {
                    failCount++;
                } else if (!companyData.fallback) {
                    successCount++;
                }
                
                // Add small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            loadingDiv.style.display = 'none';
            renderCompaniesTable();
            
            // Update final status
            if (successCount > 0) {
                updateCompaniesStatus(`Live data loaded! ${successCount} live, ${companiesData.length - successCount - failCount} demo, ${failCount} failed`, true);
            } else {
                updateCompaniesStatus(`Live data failed. Using demo data. Try alternative APIs or check CORS settings.`, false);
            }
        }

        // Render companies table
        function renderCompaniesTable() {
            console.log("renderCompaniesTable called");
            console.log("companiesData:", companiesData);
            
            const table = $('#companiesTable');
            console.log("table element found:", table.length > 0);
            
            if ($.fn.dataTable.isDataTable(table)) {
                table.DataTable().destroy();
            }
            
            const tbody = table.find('tbody')[0];
            console.log("tbody element found:", tbody ? true : false);
            
            if (!tbody) {
                console.error("Companies table tbody not found!");
                return;
            }
            
            tbody.innerHTML = companiesData.map(company => {
                const last = parseFloat(company.lastPrice);
                const high52 = parseFloat(company.weekHigh52);
                const low52 = parseFloat(company.weekLow52);
                const change = parseFloat(company.pChange);
                
                const toHigh = high52 > 0 ? (((high52 - last) / last) * 100).toFixed(2) : 0;
                const toLow = low52 > 0 ? (((last - low52) / last) * 100).toFixed(2) : 0;
                const riskReward = parseFloat(toLow) > 0 ? (parseFloat(toHigh) / parseFloat(toLow)).toFixed(2) : '‚àû';
                
                let rowClass = '';
                let dataType = '';
                if (company.error) {
                    rowClass = 'error-row';
                    dataType = ' ‚ùå';
                } else if (company.fallback) {
                    rowClass = 'fallback-row';
                    dataType = ' üìä';
                } else if (company.isLive) {
                    rowClass = 'live-row';
                    dataType = ' üü¢';
                } else {
                    dataType = ' üî¥';
                }
                
                return `<tr class="${rowClass}">
                    <td><strong>${company.companyName}${dataType}</strong></td>
                    <td>${company.symbol}</td>
                    <td>‚Çπ${last.toLocaleString()}</td>
                    <td style="color: ${change >= 0 ? 'green' : 'red'}; font-weight: bold;">${change.toFixed(2)}%</td>
                    <td>‚Çπ${high52.toLocaleString()}</td>
                    <td>‚Çπ${low52.toLocaleString()}</td>
                    <td style='color: blue; font-weight: bold;'>${toHigh}%</td>
                    <td style='color: orange; font-weight: bold;'>${toLow}%</td>
                    <td style='font-weight: bold;'>${riskReward}</td>
                    <td>${company.totalTradedVolume.toLocaleString()}</td>
                    <td>‚Çπ${(company.marketCap / 10000000).toFixed(2)} Cr</td>
                    <td><small>${company.lastUpdated}</small></td>
                </tr>`;
            }).join('');
            
            table.DataTable({
                stateSave: true,
                pageLength: 25,
                responsive: true,
                order: [[10, 'desc']] // Sort by market cap
            });
            
            console.log("Companies table rendered successfully with", companiesData.length, "rows");
            updateCompaniesStatus(`Table displayed with ${companiesData.length} companies`, true);
        }

        // Update status message
        function updateCompaniesStatus(message, isSuccess = true) {
            const statusElement = document.getElementById('companiesStatusText');
            const statusContainer = document.getElementById('companiesStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
            if (statusContainer) {
                statusContainer.style.background = isSuccess ? '#d1ecf1' : '#f8d7da';
                statusContainer.style.borderColor = isSuccess ? '#bee5eb' : '#f1aeb5';
            }
        }

        // Load demo data immediately for testing
        function loadDemoCompaniesData() {
            console.log("loadDemoCompaniesData called");
            console.log("companiesConfig:", companiesConfig);
            
            updateCompaniesStatus("Loading demo data...", true);
            
            companiesData = companiesConfig.map(symbol => {
                const fallback = fallbackCompanyData[symbol];
                if (fallback) {
                    return {
                        symbol: symbol,
                        companyName: fallback.companyName,
                        lastPrice: fallback.lastPrice,
                        change: 0,
                        pChange: fallback.pChange,
                        dayHigh: 0,
                        dayLow: 0,
                        weekHigh52: fallback.weekHigh52,
                        weekLow52: fallback.weekLow52,
                        totalTradedVolume: fallback.totalTradedVolume,
                        marketCap: fallback.marketCap,
                        lastUpdated: new Date().toLocaleString() + ' (Demo Data)',
                        fallback: true
                    };
                }
                return {
                    symbol: symbol,
                    companyName: symbol,
                    lastPrice: 0,
                    pChange: 0,
                    weekHigh52: 0,
                    weekLow52: 0,
                    totalTradedVolume: 0,
                    marketCap: 0,
                    lastUpdated: new Date().toLocaleString(),
                    error: true
                };
            });
            
            console.log("companiesData created:", companiesData.length, "items");
            renderCompaniesTable();
            updateCompaniesStatus(`Demo data loaded successfully - ${companiesData.length} companies`, true);
        }

        function isValid(value) {
            return value && value !== "nil" && !isNaN(parseFloat(value.replace(/,/g, '')));
        }

        function populateFilters(data) {
            const typeSet = new Set();
            const subTypeSet = new Set();
            data.forEach(i => {
                if (i.indexType) typeSet.add(i.indexType);
                if (i.indexSubType) subTypeSet.add(i.indexSubType);
            });

            const typeSelect = document.getElementById("indexTypeFilter");
            const subTypeSelect = document.getElementById("indexSubTypeFilter");

            if (typeSelect) {
                for (let i = typeSelect.options.length - 1; i > 0; i--) {
                    typeSelect.remove(i);
                }
                [...typeSet].sort().forEach(type => {
                    const opt = document.createElement("option");
                    opt.value = type;
                    opt.textContent = type;
                    typeSelect.appendChild(opt);
                });
            }

            if (subTypeSelect) {
                for (let i = subTypeSelect.options.length - 1; i > 0; i--) {
                    subTypeSelect.remove(i);
                }
                [...subTypeSet].sort().forEach(sub => {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.textContent = sub;
                    subTypeSelect.appendChild(opt);
                });
            }
        }

        function renderTable(data, tableId) {
            const table = $(`#${tableId}`);
            if (!table.length) return;
            if ($.fn.dataTable.isDataTable(table)) {
                table.DataTable().destroy();
            }
            const tbody = table.find("tbody")[0];
            if (!tbody) return;
            tbody.innerHTML = data.map(index => {
                const last = parseFloat(index.last.replace(/,/g, ''));
                const high = parseFloat(index.yearHigh.replace(/,/g, ''));
                const low = parseFloat(index.yearLow.replace(/,/g, ''));
                const change = parseFloat(index.percChange);
                const toHigh = (((high - last) / last) * 100).toFixed(2);
                const toLow = (((last - low) / last) * 100).toFixed(2);
                const riskReward = parseFloat(toLow) > 0 ? (parseFloat(toHigh) / parseFloat(toLow)).toFixed(2) : '‚àû';
                return `<tr>
                    <td><strong>${index.indexName}</strong></td>
                    <td>${index.last}</td>
                    <td style="color: ${change >= 0 ? 'green' : 'red'}; font-weight: bold;">${change}%</td>
                    <td>${index.yearHigh} <br><small style="color: #666;">(${((last - high) / high * 100).toFixed(2)}%)</small></td>
                    <td>${index.yearLow} <br><small style="color: #666;">(${((last - low) / low * 100).toFixed(2)}%)</small></td>
                    <td style='color: blue; font-weight: bold;'>${toHigh}%</td>
                    <td style='color: orange; font-weight: bold;'>${toLow}%</td>
                    <td style='font-weight: bold;'>${riskReward}</td>
                    <td><small>${index.timeVal}</small></td>
                </tr>`;
            }).join('');
            table.DataTable({ 
                stateSave: true,
                pageLength: 10,
                responsive: true,
                order: [[1, 'desc']]
            });
        }

        async function fetchAndRender() {
            try {
                document.getElementById("errorMsg").style.display = "none";
                const timestamp = Date.now();
                const res = await fetch(`https://iislliveblob.niftyindices.com/jsonfiles/LiveIndicesWatch.json?_=${timestamp}`);
                if (!res.ok) throw new Error("Response not OK");
                const json = await res.json();
                const fullData = json.data;

                populateFilters(fullData);

                const selectedType = document.getElementById("indexTypeFilter").value || "all";
                const selectedSubType = document.getElementById("indexSubTypeFilter").value || "all";

                const filteredAll = fullData.filter(i =>
                    isValid(i.yearHigh) &&
                    isValid(i.yearLow) &&
                    isValid(i.last) &&
                    (selectedType === "all" || i.indexType === selectedType) &&
                    (selectedSubType === "all" || i.indexSubType === selectedSubType)
                );

                renderTable(filteredAll.filter(i =>
                    ["NIFTY 50", "NIFTY NEXT 50", "NIFTY MIDCAP 150", "NIFTY SMALLCAP 250", "NIFTY MICROCAP250"].includes(i.indexName)
                ), "topIndicesTable");

                renderTable(filteredAll.filter(i =>
                    ["NIFTY BANK", "NIFTY IT", "NIFTY AUTO"].includes(i.indexName)
                ), "sectorIndicesTable");

                renderTable(filteredAll, "allIndicesTable");

            } catch (err) {
                console.error("Fetch error", err);
                document.getElementById("errorMsg").style.display = "block";
                populateFilters(fallbackData);
                renderTable(fallbackData.filter(i =>
                    ["NIFTY 50", "NIFTY NEXT 50", "NIFTY MIDCAP 150", "NIFTY SMALLCAP 250", "NIFTY MICROCAP250"].includes(i.indexName)
                ), "topIndicesTable");
                renderTable(fallbackData.filter(i =>
                    ["NIFTY BANK", "NIFTY IT", "NIFTY AUTO"].includes(i.indexName)
                ), "sectorIndicesTable");
                renderTable(fallbackData, "allIndicesTable");
            }
        }

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById("refreshInterval").value || 60000);
            console.log("Starting auto refresh with interval:", interval);
            clearInterval(window.intervalId);
            
            if (document.getElementById("autoRefreshToggle").checked) {
                window.intervalId = setInterval(() => {
                    console.log("Auto refresh triggered");
                    fetchAndRender();
                }, interval);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchAndRender();
            
            // Event listeners
            document.getElementById("refreshInterval").addEventListener("change", function() {
                console.log("Refresh interval changed to:", this.value);
                startAutoRefresh();
            });
            
            document.getElementById("autoRefreshToggle").addEventListener("change", function() {
                console.log("Auto refresh toggled:", this.checked);
                if (this.checked) {
                    fetchAndRender();
                    startAutoRefresh();
                } else {
                    clearInterval(window.intervalId);
                }
            });
            
            document.getElementById("indexTypeFilter").addEventListener("change", fetchAndRender);
            document.getElementById("indexSubTypeFilter").addEventListener("change", fetchAndRender);
            
            // Initialize companies tab
            const autoLoadLive = document.getElementById('autoLoadLiveData');
            if (autoLoadLive && autoLoadLive.checked) {
                console.log("Auto-loading live companies data...");
                loadCompaniesData();
            } else {
                console.log("Loading demo companies data...");
                loadDemoCompaniesData();
                console.log("Demo companies data loaded, count:", companiesData.length);
            }
            
            // Start auto refresh
            startAutoRefresh();
        });
    </script>
</body>
</html>
