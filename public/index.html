<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIFTY Indices Dashboard</title>
    
    <!-- Enhanced CDN Resources -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
            --hover-shadow: 0 15px 40px rgba(0,0,0,0.15);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #2c3e50;
            line-height: 1.6;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
            margin-bottom: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="0,0 1000,0 1000,100"/></svg>');
            background-size: 100% 100%;
            pointer-events: none;
        }

        .hero-content {
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            animation: fadeInUp 1s ease-out;
        }

        .hero-subtitle {
            font-size: 1.3rem;
            font-weight: 300;
            opacity: 0.9;
            margin-bottom: 2rem;
            animation: fadeInUp 1s ease-out 0.2s both;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            animation: fadeInUp 1s ease-out 0.4s both;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .glass-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: var(--transition);
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .controls-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .form-select, .form-control {
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: var(--transition);
            background: white;
        }

        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }

        .btn-modern {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            color: white;
        }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);
        }

        .btn-warning {
            background: var(--warning-gradient);
            box-shadow: 0 4px 15px rgba(247, 148, 164, 0.4);
        }

        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(247, 148, 164, 0.6);
        }

        .btn-danger {
            background: var(--danger-gradient);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: var(--dark-gradient);
            box-shadow: 0 4px 15px rgba(44, 62, 80, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.6);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
        }

        .btn-info:hover {
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.6);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-text {
            font-weight: 600;
            color: #28a745;
        }

        .modern-tabs {
            display: flex;
            background: rgba(255,255,255,0.8);
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .modern-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .modern-tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .modern-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .alert-modern {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: none;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-weight: 500;
        }

        .alert-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
            color: white;
        }

        .alert-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .alert-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }



        .table {
            margin: 0;
            min-width: 100%;
        }

        .table thead th {
            background: var(--dark-gradient);
            color: white;
            font-weight: 600;
            border: none;
            padding: 0.75rem 0.5rem;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            white-space: nowrap;
            min-width: 100px;
        }

        .table tbody td {
            padding: 0.75rem 0.5rem;
            vertical-align: middle;
            border-top: 1px solid rgba(0,0,0,0.05);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .table tbody tr {
            transition: var(--transition);
        }

        .table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        /* DataTables scrolling customization */
        .dataTables_scrollHead .table thead th {
            background: var(--dark-gradient);
            color: white;
            border-bottom: 2px solid #667eea;
        }

        .dataTables_scrollBody {
            border-top: none;
        }

        /* Fix for DataTables processing overlay */
        .dataTables_processing {
            z-index: 9999 !important;
        }

        /* DataTables scrolling alignment fixes */
        .dataTables_scroll {
            clear: both;
        }
        
        .dataTables_scrollHead table,
        .dataTables_scrollBody table {
            border-collapse: collapse !important;
            table-layout: fixed !important;
        }
        
        .dataTables_scrollHead {
            border-bottom: 1px solid #dee2e6;
        }

        /* Compact display for small text in cells */
        .table small {
            font-size: 0.7rem;
            display: block;
            margin-top: 0.25rem;
        }



        /* Mobile responsive optimizations */
        @media (max-width: 768px) {
            .table thead th {
                padding: 0.5rem 0.25rem;
                font-size: 0.7rem;
            }
            
            .table tbody td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
            
            .table small {
                font-size: 0.65rem;
            }
        }

        @media (max-width: 480px) {
            .table thead th {
                padding: 0.4rem 0.2rem;
                font-size: 0.65rem;
            }
            
            .table tbody td {
                padding: 0.4rem 0.2rem;
                font-size: 0.7rem;
            }
        }

        .checkbox-modern {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .checkbox-modern input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .checkbox-modern input[type="checkbox"]:checked {
            background: var(--primary-gradient);
            border-color: #667eea;
        }

        .company-config {
            background: rgba(248, 249, 250, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .company-config h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .company-config textarea {
            width: 100%;
            height: 120px;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            resize: vertical;
            background: white;
            transition: var(--transition);
        }

        .company-config textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .loading-spinner i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .info-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        .status-box {
            background: rgba(23, 162, 184, 0.1);
            border: 1px solid rgba(23, 162, 184, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .status-box strong {
            color: #17a2b8;
        }

        /* DataTables Custom Styling */
        .dataTables_wrapper {
            padding: 1.5rem;
        }

        .dataTables_filter input {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
        }

        .dataTables_length select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 0.5rem;
            margin: 0 0.5rem;
        }

        .page-link {
            border-radius: 8px;
            border: 2px solid transparent;
            margin: 0 2px;
            transition: var(--transition);
        }

        .page-link:hover {
            background: var(--primary-gradient);
            border-color: #667eea;
            color: white;
        }

        .page-item.active .page-link {
            background: var(--primary-gradient);
            border-color: #667eea;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .hero-subtitle {
                font-size: 1.1rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .modern-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .modern-tab {
                padding: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                padding: 10px;
            }
            
            .hero-section {
                padding: 40px 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.5; 
                transform: scale(1.1);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Row styling for different data types */
        .error-row {
            background: rgba(255, 107, 107, 0.1) !important;
            border-left: 4px solid #ff6b6b !important;
        }

        .fallback-row {
            background: rgba(79, 172, 254, 0.1) !important;
            border-left: 4px solid #4facfe !important;
        }

        .live-row {
            background: rgba(40, 167, 69, 0.1) !important;
            border-left: 4px solid #28a745 !important;
        }

        .demo-notice {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">
                    <i class="fas fa-chart-line"></i>
                    NIFTY Indices Live Dashboard
                </h1>
                <p class="hero-subtitle">
                    Real-time Indian stock market indices with advanced risk-reward analysis
                </p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-chart-bar"></i>
                            50+
                        </div>
                        <div class="stat-label">Live Indices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-building"></i>
                            20+
                        </div>
                        <div class="stat-label">Companies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-clock"></i>
                            Real-time
                        </div>
                        <div class="stat-label">Updates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">
                            <i class="fas fa-calculator"></i>
                            Advanced
                        </div>
                        <div class="stat-label">Analytics</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMsg" class="alert-modern alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span>⚠️ Unable to fetch live data. Showing fallback data instead.</span>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="refreshInterval">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Interval
                    </label>
                    <select id="refreshInterval" class="form-select">
                        <option value="30000">30 seconds</option>
                        <option value="60000" selected>1 minute</option>
                        <option value="300000">5 minutes</option>
                        <option value="600000">10 minutes</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>&nbsp;</label>
                    <div class="checkbox-modern">
                        <input type="checkbox" id="autoRefreshToggle" checked>
                        <label for="autoRefreshToggle">
                            <i class="fas fa-play"></i>
                            Auto Refresh
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Indicator -->
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span class="status-text">
                <i class="fas fa-satellite-dish"></i>
                Live Data Feed Active
            </span>
        </div>

        <!-- Modern Tabs -->
        <div class="modern-tabs">
            <button class="modern-tab active" onclick="switchTab('indices')">
                <i class="fas fa-chart-line"></i>
                Indices
            </button>
            <button class="modern-tab" onclick="switchTab('companies')">
                <i class="fas fa-building"></i>
                Companies
            </button>
        </div>

        <!-- Indices Tab -->
        <div id="indicesTab" class="tab-content active">
            <!-- Top Indices -->
            <div class="glass-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-trophy"></i>
                        Top Market Indices
                    </h2>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="topIndicesTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Index Name</th>
                                    <th>Last Price</th>
                                    <th>Change %</th>
                                    <th>Year High</th>
                                    <th>Year Low</th>
                                    <th>Distance to High</th>
                                    <th>Distance from Low</th>
                                    <th>Risk/Reward</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sector Indices -->
            <div class="glass-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-industry"></i>
                        Sector Indices
                    </h2>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="sectorIndicesTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Index Name</th>
                                    <th>Last Price</th>
                                    <th>Change %</th>
                                    <th>Year High</th>
                                    <th>Year Low</th>
                                    <th>Distance to High</th>
                                    <th>Distance from Low</th>
                                    <th>Risk/Reward</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- All Indices -->
            <div class="glass-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-list"></i>
                        All Indices
                    </h2>
                </div>
                <div class="card-body">
                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="indexTypeFilter">
                                <i class="fas fa-filter"></i>
                                Index Type
                            </label>
                            <select id="indexTypeFilter" class="form-select">
                                <option value="all">All Types</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="indexSubTypeFilter">
                                <i class="fas fa-tags"></i>
                                Index Sub-Type
                            </label>
                            <select id="indexSubTypeFilter" class="form-select">
                                <option value="all">All Sub-Types</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table id="allIndicesTable" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Index Name</th>
                                    <th>Last Price</th>
                                    <th>Change %</th>
                                    <th>Year High</th>
                                    <th>Year Low</th>
                                    <th>Distance to High</th>
                                    <th>Distance from Low</th>
                                    <th>Risk/Reward</th>
                                    <th>Last Updated</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Companies Tab -->
        <div id="companiesTab" class="tab-content">
            <div class="company-config">
                <h3>
                    <i class="fas fa-cogs"></i>
                    Company Configuration
                </h3>
                <p>Add or remove companies from the list below (JSON format):</p>
                <textarea id="companiesConfig" placeholder='["TCS", "RELIANCE", "HDFCBANK", "INFY", "HINDUNILVR", "ICICIBANK", "SBIN", "BHARTIARTL", "ITC", "KOTAKBANK"]'>["TCS", "RELIANCE", "HDFCBANK", "INFY", "HINDUNILVR", "ICICIBANK", "SBIN", "BHARTIARTL", "ITC", "KOTAKBANK", "LT", "ASIANPAINT", "AXISBANK", "MARUTI", "SUNPHARMA", "TITAN", "ULTRACEMCO", "NESTLEIND", "BAJFINANCE", "POWERGRID"]</textarea>
                
                <div class="button-group">
                    <button class="btn-modern" onclick="loadCompaniesData()">
                        <i class="fas fa-sync-alt"></i>
                        Load NSE Data
                    </button>
                    <button class="btn-modern btn-warning" onclick="loadScreenerData()">
                        <i class="fas fa-search"></i>
                        Load Screener Data
                    </button>
                    <button class="btn-modern btn-success" onclick="loadDemoCompaniesData()">
                        <i class="fas fa-chart-bar"></i>
                        Load Demo Data
                    </button>
                    <button class="btn-modern btn-secondary" onclick="saveCompaniesConfig()">
                        <i class="fas fa-save"></i>
                        Save Config
                    </button>
                    <button class="btn-modern btn-info" onclick="testCompaniesData()">
                        <i class="fas fa-flask"></i>
                        Test NSE
                    </button>
                    <button class="btn-modern btn-info" onclick="testScreenerData()">
                        <i class="fas fa-vial"></i>
                        Test Screener
                    </button>
                    <button class="btn-modern btn-secondary" onclick="checkScreenerCORS()">
                        <i class="fas fa-shield-alt"></i>
                        Check CORS
                    </button>
                    <button class="btn-modern btn-danger" onclick="clearDemoData()">
                        <i class="fas fa-trash"></i>
                        Clear Demo Data
                    </button>
                </div>
                
                <div class="checkbox-modern">
                    <input type="checkbox" id="autoLoadLiveData">
                    <label for="autoLoadLiveData">
                        <i class="fas fa-play-circle"></i>
                        Auto-load Live Data on startup (experimental)
                    </label>
                </div>
                
                <div class="info-box">
                    <strong>
                        <i class="fas fa-rocket"></i>
                        🚀 Vercel API Proxy for Screener.in:
                    </strong><br>
                    • ✅ No CORS issues - works seamlessly<br>
                    • 🔧 Server-side data fetching via Vercel<br>
                    • 🌐 No browser extensions required<br>
                    • 🚀 Production-ready deployment<br>
                    <br>
                    <strong>📈 Screener.in via Vercel Benefits:</strong><br>
                    • 🎯 Rich fundamental data extraction<br>
                    • 📊 Market cap, PE ratios, sector info<br>
                    • 🔄 Real-time data from live pages<br>
                    • 💯 Reliable server-side processing<br>
                    • ⚡ Fast serverless function execution
                </div>
                
                <div id="companiesStatus" class="status-box">
                    <strong>
                        <i class="fas fa-info-circle"></i>
                        Status:
                    </strong>
                    <span id="companiesStatusText">Ready to load data</span>
                </div>
            </div>
            
            <div id="companiesLoading" class="loading-spinner" style="display: none;">
                <i class="fas fa-spinner"></i>
                <div id="loadingProgress">Loading...</div>
            </div>
            
            <div class="glass-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-building"></i>
                        Companies Data
                    </h2>
                </div>
                <div class="card-body">
                    <div class="alert-modern alert-info">
                        <i class="fas fa-rocket"></i>
                        <div>
                            <strong>⚡ Multiple Data Sources:</strong> 
                            🚀 NSE Batch API | 📈 Screener.in via Vercel | 📊 Demo Data Fallback | ❌ Error/Missing
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="companiesTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Sector</th>
                                <th>Price</th>
                                <th>52W High</th>
                                <th>52W Low</th>
                                <th>To High</th>
                                <th>From Low</th>
                                <th>Price R/R</th>
                                <th>PE R/R</th>
                                <th>Score</th>
                                <th>Current PE</th>
                                <th>PE @ High</th>
                                <th>PE @ Low</th>
                                <th>Updated</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script>
        const fallbackData = [
            {
                indexName: "NIFTY 50",
                last: "22,000",
                yearHigh: "23,000",
                yearLow: "17,000",
                percChange: "0.35",
                indexType: "Broad Market",
                indexSubType: "Large Cap",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY BANK",
                last: "47,000",
                yearHigh: "48,000",
                yearLow: "38,000",
                percChange: "0.50",
                indexType: "Sectoral",
                indexSubType: "Banking",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY IT",
                last: "35,000",
                yearHigh: "36,000",
                yearLow: "28,000",
                percChange: "-0.25",
                indexType: "Sectoral",
                indexSubType: "Information Technology",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY AUTO",
                last: "18,500",
                yearHigh: "19,000",
                yearLow: "15,000",
                percChange: "0.75",
                indexType: "Sectoral",
                indexSubType: "Automobile",
                timeVal: new Date().toLocaleString()
            },
            {
                indexName: "NIFTY NEXT 50",
                last: "65,000",
                yearHigh: "68,000",
                yearLow: "52,000",
                percChange: "0.45",
                indexType: "Broad Market",
                indexSubType: "Large Cap",
                timeVal: new Date().toLocaleString()
            }
        ];

        // Company data storage
        let companiesData = [];
        let companiesConfig = ["TCS", "RELIANCE", "HDFCBANK", "INFY", "HINDUNILVR", "ICICIBANK", "SBIN", "BHARTIARTL", "ITC", "KOTAKBANK", "LT", "ASIANPAINT", "AXISBANK", "MARUTI", "SUNPHARMA", "TITAN", "ULTRACEMCO", "NESTLEIND", "BAJFINANCE", "POWERGRID"];

        // Load companies config from textarea
        function loadCompaniesConfig() {
            try {
                const configText = document.getElementById('companiesConfig').value;
                companiesConfig = JSON.parse(configText);
                return true;
            } catch (e) {
                alert('Invalid JSON format in companies configuration');
                return false;
            }
        }

        // Save companies config
        function saveCompaniesConfig() {
            if (loadCompaniesConfig()) {
                alert('Companies configuration saved successfully!');
            }
        }

                 // Clear demo data and show only live data
        function clearDemoData() {
            updateCompaniesStatus("Clearing demo data...", true);
            companiesData = companiesData.filter(company => !company.fallback && !company.error);
            
            if (companiesData.length === 0) {
                updateCompaniesStatus("No live data available. All data was demo/fallback.", false);
                // Clear the table
                const table = $('#companiesTable');
                if ($.fn.dataTable.isDataTable(table)) {
                    table.DataTable().destroy();
                }
                table.find('tbody')[0].innerHTML = '<tr><td colspan="14" style="text-align: center; padding: 20px; color: #666;">No live data available. Click "Load Live Data" to fetch real data.</td></tr>';
            } else {
                renderCompaniesTable();
                updateCompaniesStatus(`Showing ${companiesData.length} companies with live data only`, true);
            }
        }

        // Test Vercel API proxy with RELIANCE
        async function testNSEAPI() {
            updateCompaniesStatus("Testing Vercel API proxy with RELIANCE...", true);
            console.log("=== VERCEL API PROXY TEST ===");
            
            try {
                const testData = await fetchCompanyData('RELIANCE');
                console.log("Vercel API Test Result:", testData);
                
                if (testData.isLive) {
                    updateCompaniesStatus(`✅ Vercel API Success! Got live data for RELIANCE (₹${testData.lastPrice})`, true);
                    
                    // Add test result to table
                    const existingIndex = companiesData.findIndex(c => c.symbol === 'RELIANCE');
                    if (existingIndex >= 0) {
                        companiesData[existingIndex] = testData;
                    } else {
                        companiesData.unshift(testData);
                    }
                    renderCompaniesTable();
                } else if (testData.fallback) {
                    updateCompaniesStatus("⚠️ Vercel API failed, using demo data for RELIANCE", false);
                } else {
                    updateCompaniesStatus("❌ Vercel API test failed completely", false);
                }
            } catch (error) {
                console.error("Vercel API Test Error:", error);
                updateCompaniesStatus(`❌ Vercel API Error: ${error.message}`, false);
            }
        }

        // Test different CORS solutions
        async function testCORSSolutions() {
            updateCompaniesStatus("Testing CORS solutions...", true);
            console.log("=== CORS SOLUTIONS TEST ===");
            
            const corsTests = [
                {
                    name: "Direct NSE API",
                    url: "https://www.nseindia.com/api/quote-equity?symbol=RELIANCE",
                    expectedResult: "Will fail due to CORS policy"
                },
                {
                    name: "AllOrigins Proxy",
                    url: "https://api.allorigins.win/get?url=" + encodeURIComponent("https://www.nseindia.com/api/quote-equity?symbol=RELIANCE"),
                    expectedResult: "Should work if proxy is online"
                },
                {
                    name: "CORS.io Proxy",
                    url: "https://corsproxy.io/?https://www.nseindia.com/api/quote-equity?symbol=RELIANCE",
                    expectedResult: "Alternative proxy service"
                }
            ];
            
            let results = [];
            
            for (let test of corsTests) {
                try {
                    console.log(`Testing: ${test.name}`);
                    updateCompaniesStatus(`Testing ${test.name}...`, true);
                    
                    const response = await fetch(test.url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log(`✅ ${test.name} SUCCESS:`, data);
                        results.push(`✅ ${test.name}: SUCCESS`);
                    } else {
                        console.log(`❌ ${test.name} FAILED: HTTP ${response.status}`);
                        results.push(`❌ ${test.name}: HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.log(`❌ ${test.name} ERROR:`, error.message);
                    results.push(`❌ ${test.name}: ${error.message.substring(0, 50)}...`);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            updateCompaniesStatus(`CORS Test Results: ${results.join(' | ')}`, results.some(r => r.includes('SUCCESS')));
            
            // Show detailed results in console
            console.log("=== CORS TEST SUMMARY ===");
            results.forEach(result => console.log(result));
        }

        // Quick CORS status check
        async function checkCORSStatus() {
            updateCompaniesStatus("Checking CORS status...", true);
            
            try {
                // Quick test with a simple NSE API call
                const response = await fetch('https://www.nseindia.com/api/quote-equity?symbol=RELIANCE', {
                    method: 'HEAD', // Lighter request
                    mode: 'cors'
                });
                
                if (response.ok) {
                    updateCompaniesStatus("✅ CORS is working! Direct NSE API access enabled.", true);
                    console.log("✅ CORS Check: Direct API access is working");
                } else {
                    updateCompaniesStatus(`⚠️ CORS enabled but API returned HTTP ${response.status}`, false);
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    updateCompaniesStatus("❌ CORS is blocked. Install browser extension or use proxies.", false);
                    console.log("❌ CORS Check: Blocked by CORS policy");
                } else {
                    updateCompaniesStatus(`❌ Network error: ${error.message.substring(0, 50)}...`, false);
                    console.log("❌ CORS Check: Network error", error);
                }
            }
        }

        // Test function for debugging
        function testCompaniesData() {
            console.log("=== COMPANIES DEBUG TEST ===");
            console.log("companiesData length:", companiesData.length);
            console.log("companiesConfig:", companiesConfig);
            console.log("Table element exists:", $('#companiesTable').length > 0);
            console.log("Table body exists:", $('#companiesTable tbody').length > 0);
            console.log("Current tab:", document.querySelector('.tab-content.active')?.id || 'none');
            
            updateCompaniesStatus("Running diagnostics...", true);
            
            if (companiesData.length === 0) {
                console.log("No companies data found, loading demo data...");
                updateCompaniesStatus("No data found, loading demo data...", true);
                loadDemoCompaniesData();
            } else {
                console.log("Companies data exists, re-rendering table...");
                updateCompaniesStatus("Refreshing table display...", true);
                renderCompaniesTable();
            }
            
            // Show diagnostic results
            setTimeout(() => {
                const diagnostics = [
                    `Data: ${companiesData.length} companies`,
                    `Table: ${$('#companiesTable').length > 0 ? 'Found' : 'Missing'}`,
                    `Tab: ${document.querySelector('.tab-content.active')?.id || 'Unknown'}`
                ].join(' | ');
                updateCompaniesStatus(`Diagnostics: ${diagnostics}`, true);
            }, 1000);
        }

        // Comprehensive diagnostic function
        async function runComprehensiveDiagnostics() {
            console.log("=== COMPREHENSIVE DIAGNOSTICS ===");
            updateCompaniesStatus("Running comprehensive diagnostics...", true);
            
            const results = {
                browserInfo: {},
                corsPlugin: {},
                nseApiTest: {},
                proxies: {},
                recommendations: []
            };
            
            // 1. Browser Information
            console.log("1. Browser Information:");
            results.browserInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                protocol: location.protocol,
                hostname: location.hostname,
                port: location.port || 'default'
            };
            console.log("Browser Info:", results.browserInfo);
            
            // 2. CORS Plugin Test
            console.log("\n2. CORS Plugin Test:");
            try {
                const corsTestUrl = 'https://httpbin.org/headers';
                const corsResponse = await fetch(corsTestUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (corsResponse.ok) {
                    const corsData = await corsResponse.json();
                    results.corsPlugin = {
                        working: true,
                        headers: corsData.headers,
                        message: "CORS plugin appears to be working"
                    };
                    console.log("✅ CORS Plugin Test: PASSED");
                } else {
                    results.corsPlugin = {
                        working: false,
                        status: corsResponse.status,
                        message: `CORS test failed with status ${corsResponse.status}`
                    };
                    console.log("❌ CORS Plugin Test: FAILED");
                }
            } catch (corsError) {
                results.corsPlugin = {
                    working: false,
                    error: corsError.message,
                    message: "CORS plugin may not be working properly"
                };
                console.log("❌ CORS Plugin Test: ERROR", corsError.message);
            }
            
            // 3. NSE API Direct Test
            console.log("\n3. NSE API Direct Test:");
            try {
                const nseUrl = 'https://www.nseindia.com/api/quote-equity?symbol=RELIANCE';
                const nseResponse = await fetch(nseUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Referer': 'https://www.nseindia.com/',
                        'Origin': 'https://www.nseindia.com'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log("NSE Response Status:", nseResponse.status);
                console.log("NSE Response Headers:", [...nseResponse.headers.entries()]);
                
                if (nseResponse.ok) {
                    const nseData = await nseResponse.json();
                    results.nseApiTest = {
                        working: true,
                        status: nseResponse.status,
                        hasData: !!(nseData.info || nseData.priceInfo),
                        dataStructure: Object.keys(nseData),
                        message: "NSE API direct access working!"
                    };
                    console.log("✅ NSE API Direct Test: SUCCESS", nseData);
                } else {
                    const responseText = await nseResponse.text();
                    results.nseApiTest = {
                        working: false,
                        status: nseResponse.status,
                        statusText: nseResponse.statusText,
                        responseText: responseText.substring(0, 200),
                        message: `NSE API returned ${nseResponse.status}: ${nseResponse.statusText}`
                    };
                    console.log("❌ NSE API Direct Test: HTTP ERROR", nseResponse.status, responseText);
                }
            } catch (nseError) {
                results.nseApiTest = {
                    working: false,
                    error: nseError.message,
                    errorType: nseError.name,
                    message: "NSE API direct access failed"
                };
                console.log("❌ NSE API Direct Test: EXCEPTION", nseError);
            }
            
            // 4. Proxy Services Test
            console.log("\n4. Proxy Services Test:");
            const proxyServices = [
                {
                    name: 'AllOrigins',
                    url: 'https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.nseindia.com/api/quote-equity?symbol=RELIANCE')
                },
                {
                    name: 'CORS.io',
                    url: 'https://corsproxy.io/?https://www.nseindia.com/api/quote-equity?symbol=RELIANCE'
                },
                {
                    name: 'CodeTabs',
                    url: 'https://api.codetabs.com/v1/proxy?quest=https://www.nseindia.com/api/quote-equity?symbol=RELIANCE'
                }
            ];
            
            results.proxies = {};
            
            for (const proxy of proxyServices) {
                try {
                    console.log(`Testing ${proxy.name}...`);
                    const proxyResponse = await fetch(proxy.url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (proxyResponse.ok) {
                        const proxyData = await proxyResponse.json();
                        results.proxies[proxy.name] = {
                            working: true,
                            status: proxyResponse.status,
                            hasData: !!(proxyData.contents || proxyData.info || proxyData.priceInfo),
                            message: "Proxy service working"
                        };
                        console.log(`✅ ${proxy.name}: SUCCESS`);
                    } else {
                        results.proxies[proxy.name] = {
                            working: false,
                            status: proxyResponse.status,
                            message: `HTTP ${proxyResponse.status}`
                        };
                        console.log(`❌ ${proxy.name}: HTTP ${proxyResponse.status}`);
                    }
                } catch (proxyError) {
                    results.proxies[proxy.name] = {
                        working: false,
                        error: proxyError.message,
                        message: "Proxy service failed"
                    };
                    console.log(`❌ ${proxy.name}: ERROR`, proxyError.message);
                }
            }
            
            // 5. Generate Recommendations
            console.log("\n5. Generating Recommendations:");
            
            if (results.nseApiTest.working) {
                results.recommendations.push("✅ NSE API is working directly! Your CORS plugin is properly configured.");
            } else if (results.corsPlugin.working && !results.nseApiTest.working) {
                results.recommendations.push("⚠️ CORS plugin is working but NSE API is blocked. NSE may have additional anti-bot measures.");
                results.recommendations.push("💡 Try: 1) Different User-Agent, 2) Visit nseindia.com first to get session cookies, 3) Try different CORS plugin");
            } else if (!results.corsPlugin.working) {
                results.recommendations.push("❌ CORS plugin doesn't seem to be working properly.");
                results.recommendations.push("💡 Try: 1) Restart browser, 2) Check plugin settings, 3) Try different CORS extension");
            }
            
            const workingProxies = Object.values(results.proxies).filter(p => p.working).length;
            if (workingProxies > 0) {
                results.recommendations.push(`✅ ${workingProxies} proxy service(s) are working as fallback.`);
            } else {
                results.recommendations.push("❌ No proxy services are working. Network may be restricted.");
            }
            
            // Display Results
            console.log("\n=== DIAGNOSTIC RESULTS ===");
            console.log("Full Results:", results);
            
            const summary = [
                `Browser: ${results.browserInfo.userAgent.split(' ')[0]}`,
                `CORS Plugin: ${results.corsPlugin.working ? '✅ Working' : '❌ Not Working'}`,
                `NSE Direct: ${results.nseApiTest.working ? '✅ Working' : '❌ Blocked'}`,
                `Proxies: ${workingProxies}/${proxyServices.length} working`
            ].join(' | ');
            
            updateCompaniesStatus(`Diagnostics Complete: ${summary}`, results.nseApiTest.working || workingProxies > 0);
            
            // Show recommendations
            if (results.recommendations.length > 0) {
                console.log("\n=== RECOMMENDATIONS ===");
                results.recommendations.forEach(rec => console.log(rec));
                
                // Also show in UI
                alert("Diagnostic Results:\n\n" + results.recommendations.join('\n\n') + "\n\nCheck browser console for detailed results.");
            }
            
            return results;
        }

        // Open NSE website to get session cookies
        function openNSEWebsite() {
            updateCompaniesStatus("Opening NSE website to get session cookies...", true);
            
            // Open NSE website in new tab
            const nseWindow = window.open('https://www.nseindia.com', '_blank');
            
            if (nseWindow) {
                // Show instructions
                alert("NSE website opened in new tab.\n\n" +
                      "Steps:\n" +
                      "1. Wait for NSE website to fully load\n" +
                      "2. Browse around a bit (optional)\n" +
                      "3. Close that tab and return here\n" +
                      "4. Click '🔄 Load Live Data' to test\n\n" +
                      "This helps NSE API recognize your browser as legitimate.");
                
                updateCompaniesStatus("NSE website opened. Follow instructions and return here to test API.", true);
            } else {
                alert("Popup blocked! Please allow popups for this site or manually visit:\nhttps://www.nseindia.com");
                updateCompaniesStatus("Popup blocked. Please manually visit NSE website.", false);
            }
        }

        // Test if session cookies are working
        async function testSessionCookies() {
            updateCompaniesStatus("Testing NSE session cookies...", true);
            console.log("=== NSE SESSION TEST ===");
            
            try {
                // Test with a simple NSE API call
                const response = await fetch('https://www.nseindia.com/api/allIndices', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Referer': 'https://www.nseindia.com/',
                        'Origin': 'https://www.nseindia.com'
                    },
                    mode: 'cors',
                    credentials: 'include'
                });
                
                console.log("Session Test Response Status:", response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log("✅ Session cookies working! API response:", data);
                    updateCompaniesStatus("✅ Session cookies working! NSE API is accessible.", true);
                    
                    // Show success message
                    alert("✅ Success! Session cookies are working.\n\nNSE API is now accessible. You can load live company data.");
                } else if (response.status === 401) {
                    console.log("❌ Still getting 401 - session cookies not established");
                    updateCompaniesStatus("❌ Still need session cookies. Visit NSE website first.", false);
                    
                    alert("❌ Session cookies not established yet.\n\nPlease:\n1. Visit NSE website (click '🍪 Get NSE Session')\n2. Wait for it to fully load\n3. Return here and test again");
                } else {
                    console.log("⚠️ Unexpected response:", response.status);
                    updateCompaniesStatus(`⚠️ Unexpected response: ${response.status}`, false);
                }
            } catch (error) {
                console.error("Session test error:", error);
                updateCompaniesStatus(`❌ Session test failed: ${error.message}`, false);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            console.log("Switching to tab:", tabName);
            
            document.querySelectorAll('.modern-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // If switching to companies tab and no data loaded, load demo data
            if (tabName === 'companies' && companiesData.length === 0) {
                console.log("Loading demo data for companies tab");
                loadDemoCompaniesData();
            }
        }

        // Fallback company data for demo
        const fallbackCompanyData = {
            "TCS": { companyName: "Tata Consultancy Services", sector: "Information Technology", lastPrice: 3580, pChange: 0.45, weekHigh52: 4100, weekLow52: 3000, totalTradedVolume: 1500000, marketCap: 130000000000, currentPE: 28.5, sectorPE: 25.2 },
            "RELIANCE": { companyName: "Reliance Industries", sector: "Oil & Gas", lastPrice: 2850, pChange: -0.35, weekHigh52: 3100, weekLow52: 2200, totalTradedVolume: 2000000, marketCap: 190000000000, currentPE: 15.2, sectorPE: 18.7 },
            "HDFCBANK": { companyName: "HDFC Bank", sector: "Financial Services", lastPrice: 1680, pChange: 0.25, weekHigh52: 1800, weekLow52: 1350, totalTradedVolume: 1800000, marketCap: 130000000000, currentPE: 18.5, sectorPE: 16.8 },
            "INFY": { companyName: "Infosys", sector: "Information Technology", lastPrice: 1750, pChange: 0.15, weekHigh52: 1950, weekLow52: 1350, totalTradedVolume: 1200000, marketCap: 72000000000, currentPE: 27.8, sectorPE: 25.2 },
            "HINDUNILVR": { companyName: "Hindustan Unilever", sector: "Consumer Goods", lastPrice: 2650, pChange: -0.12, weekHigh52: 2900, weekLow52: 2200, totalTradedVolume: 800000, marketCap: 62000000000, currentPE: 58.2, sectorPE: 45.6 },
            "ICICIBANK": { companyName: "ICICI Bank", sector: "Financial Services", lastPrice: 1180, pChange: 0.38, weekHigh52: 1300, weekLow52: 900, totalTradedVolume: 2200000, marketCap: 82000000000, currentPE: 16.2, sectorPE: 16.8 },
            "SBIN": { companyName: "State Bank of India", sector: "Financial Services", lastPrice: 820, pChange: 0.52, weekHigh52: 900, weekLow52: 550, totalTradedVolume: 3000000, marketCap: 73000000000, currentPE: 12.8, sectorPE: 16.8 },
            "BHARTIARTL": { companyName: "Bharti Airtel", sector: "Telecommunications", lastPrice: 1520, pChange: -0.28, weekHigh52: 1700, weekLow52: 1100, totalTradedVolume: 1600000, marketCap: 85000000000, currentPE: 32.4, sectorPE: 28.5 },
            "ITC": { companyName: "ITC Limited", sector: "Consumer Goods", lastPrice: 480, pChange: 0.18, weekHigh52: 520, weekLow52: 380, totalTradedVolume: 2500000, marketCap: 60000000000, currentPE: 28.6, sectorPE: 35.2 },
            "KOTAKBANK": { companyName: "Kotak Mahindra Bank", sector: "Financial Services", lastPrice: 1850, pChange: 0.22, weekHigh52: 2100, weekLow52: 1500, totalTradedVolume: 900000, marketCap: 36000000000, currentPE: 20.5, sectorPE: 16.8 },
            "LT": { companyName: "Larsen & Toubro", sector: "Construction", lastPrice: 3650, pChange: 0.45, weekHigh52: 4000, weekLow52: 2800, totalTradedVolume: 700000, marketCap: 51000000000, currentPE: 42.8, sectorPE: 38.5 },
            "ASIANPAINT": { companyName: "Asian Paints", sector: "Chemicals", lastPrice: 3200, pChange: -0.15, weekHigh52: 3700, weekLow52: 2800, totalTradedVolume: 600000, marketCap: 31000000000, currentPE: 65.2, sectorPE: 48.7 },
            "AXISBANK": { companyName: "Axis Bank", sector: "Financial Services", lastPrice: 1150, pChange: 0.35, weekHigh52: 1350, weekLow52: 850, totalTradedVolume: 1800000, marketCap: 35000000000, currentPE: 14.8, sectorPE: 16.8 },
            "MARUTI": { companyName: "Maruti Suzuki", sector: "Automobile", lastPrice: 11500, pChange: 0.28, weekHigh52: 13000, weekLow52: 9500, totalTradedVolume: 400000, marketCap: 35000000000, currentPE: 25.8, sectorPE: 22.5 },
            "SUNPHARMA": { companyName: "Sun Pharmaceutical", sector: "Healthcare", lastPrice: 1720, pChange: -0.18, weekHigh52: 1900, weekLow52: 1200, totalTradedVolume: 1100000, marketCap: 41000000000, currentPE: 35.2, sectorPE: 28.5 },
            "TITAN": { companyName: "Titan Company", sector: "Consumer Goods", lastPrice: 3350, pChange: 0.42, weekHigh52: 3800, weekLow52: 2800, totalTradedVolume: 800000, marketCap: 30000000000, currentPE: 78.5, sectorPE: 65.2 },
            "ULTRACEMCO": { companyName: "UltraTech Cement", sector: "Cement", lastPrice: 10200, pChange: 0.15, weekHigh52: 11500, weekLow52: 8500, totalTradedVolume: 200000, marketCap: 30000000000, currentPE: 18.2, sectorPE: 22.8 },
            "NESTLEIND": { companyName: "Nestle India", sector: "Consumer Goods", lastPrice: 2450, pChange: -0.08, weekHigh52: 2800, weekLow52: 2100, totalTradedVolume: 300000, marketCap: 24000000000, currentPE: 82.5, sectorPE: 45.6 },
            "BAJFINANCE": { companyName: "Bajaj Finance", sector: "Financial Services", lastPrice: 6800, pChange: 0.65, weekHigh52: 8000, weekLow52: 5200, totalTradedVolume: 600000, marketCap: 42000000000, currentPE: 32.8, sectorPE: 28.5 },
            "POWERGRID": { companyName: "Power Grid Corp", sector: "Power", lastPrice: 320, pChange: 0.25, weekHigh52: 380, weekLow52: 250, totalTradedVolume: 1500000, marketCap: 30000000000, currentPE: 12.5, sectorPE: 15.8 }
        };

        // Helper function to process NSE API data
        function processNSEData(symbol, data, source) {
            const info = data.info || {};
            const priceInfo = data.priceInfo || {};
            const securityInfo = data.securityInfo || {};
            const preOpenMarket = data.preOpenMarket || {};
            const metadata = data.metadata || {};
            const industryInfo = data.industryInfo || {};
            
            // Calculate market cap: lastPrice * issuedSize
            const lastPrice = priceInfo.lastPrice || 0;
            const issuedSize = securityInfo.issuedSize || 0;
            const marketCap = lastPrice * issuedSize;
            
            // Use pre-market volume if available, otherwise 0
            const totalTradedVolume = preOpenMarket.totalTradedVolume || 0;
            
            // PE Ratio calculations
            const currentPE = metadata.pdSymbolPe || 0;
            const sectorPE = metadata.pdSectorPe || 0;
            const weekHigh52 = priceInfo.weekHighLow?.max || priceInfo.weekHigh52 || 0;
            const weekLow52 = priceInfo.weekHighLow?.min || priceInfo.weekLow52 || 0;
            
            // Calculate PE at 52-week high and low
            const peAtHigh = currentPE > 0 && weekHigh52 > 0 ? (currentPE * weekHigh52 / lastPrice) : 0;
            const peAtLow = currentPE > 0 && weekLow52 > 0 ? (currentPE * weekLow52 / lastPrice) : 0;
            
            // Extract sector information
            const sector = industryInfo.sector || industryInfo.basicIndustry || metadata.industry || 'Unknown';
            
            return {
                symbol: symbol,
                companyName: info.companyName || info.symbol || symbol,
                sector: sector,
                lastPrice: lastPrice,
                change: priceInfo.change || 0,
                pChange: priceInfo.pChange || 0,
                dayHigh: priceInfo.intraDayHighLow?.max || priceInfo.dayHigh || 0,
                dayLow: priceInfo.intraDayHighLow?.min || priceInfo.dayLow || 0,
                weekHigh52: weekHigh52,
                weekLow52: weekLow52,
                totalTradedVolume: totalTradedVolume,
                marketCap: marketCap,
                currentPE: currentPE,
                sectorPE: sectorPE,
                peAtHigh: peAtHigh,
                peAtLow: peAtLow,
                lastUpdated: new Date().toLocaleString() + ` (🚀 Live via ${source})`,
                isLive: true
            };
        }
        
        // Helper function to get fallback data
        function getFallbackData(symbol) {
            const fallback = fallbackCompanyData[symbol];
            if (fallback) {
                // Calculate PE at 52-week high and low
                const currentPE = fallback.currentPE || 0;
                const peAtHigh = currentPE > 0 && fallback.weekHigh52 > 0 ? (currentPE * fallback.weekHigh52 / fallback.lastPrice) : 0;
                const peAtLow = currentPE > 0 && fallback.weekLow52 > 0 ? (currentPE * fallback.weekLow52 / fallback.lastPrice) : 0;
                
                return {
                    symbol: symbol,
                    companyName: fallback.companyName,
                    sector: fallback.sector || 'Unknown',
                    lastPrice: fallback.lastPrice,
                    change: 0,
                    pChange: fallback.pChange,
                    dayHigh: 0,
                    dayLow: 0,
                    weekHigh52: fallback.weekHigh52,
                    weekLow52: fallback.weekLow52,
                    totalTradedVolume: fallback.totalTradedVolume,
                    marketCap: fallback.marketCap,
                    currentPE: currentPE,
                    sectorPE: fallback.sectorPE || 0,
                    peAtHigh: peAtHigh,
                    peAtLow: peAtLow,
                    lastUpdated: new Date().toLocaleString() + ' (📊 Demo Data)',
                    fallback: true
                };
            }
            return {
                symbol: symbol,
                companyName: symbol,
                sector: 'Unknown',
                lastPrice: 0,
                pChange: 0,
                weekHigh52: 0,
                weekLow52: 0,
                totalTradedVolume: 0,
                marketCap: 0,
                currentPE: 0,
                sectorPE: 0,
                peAtHigh: 0,
                peAtLow: 0,
                lastUpdated: new Date().toLocaleString() + ' (❌ Error)',
                error: true
            };
        }
        
        // Simple single symbol fetch (used by old functions if needed)
        async function fetchCompanyData(symbol) {
            try {
                console.log(`Fetching single symbol: ${symbol}`);
                
                const response = await fetch(`/api/nse-proxy?symbol=${symbol}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && (data.info || data.priceInfo)) {
                        return processNSEData(symbol, data, 'Vercel');
                    }
                }
                
                // Fallback to demo data
                return getFallbackData(symbol);
                
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return getFallbackData(symbol);
            }
        }

        // Load companies data using batch API call
        async function loadCompaniesData() {
            if (!loadCompaniesConfig()) return;
            
            updateCompaniesStatus("Loading data via optimized batch API...", true);
            
            const loadingDiv = document.getElementById('companiesLoading');
            const progressSpan = document.getElementById('loadingProgress');
            
            loadingDiv.style.display = 'block';
            progressSpan.textContent = `Batch loading ${companiesConfig.length} companies...`;
            companiesData = [];
            
            try {
                console.log('🔄 Loading', companiesConfig.length, 'companies via batch API');
                
                const batchResponse = await fetch(`/api/nse-proxy?symbols=${companiesConfig.join(',')}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log(`Batch API Response Status: ${batchResponse.status}`);
                
                if (batchResponse.ok) {
                    const batchData = await batchResponse.json();
                    console.log('✅ Batch API SUCCESS:', batchData.meta);
                    
                    // Process batch response
                    let successCount = 0;
                    let fallbackCount = 0;
                    
                    for (const symbol of companiesConfig) {
                        if (batchData.data[symbol]) {
                            // Success: Process NSE data
                            const data = batchData.data[symbol];
                            const processedData = processNSEData(symbol, data, 'Vercel Batch');
                            companiesData.push(processedData);
                            successCount++;
                        } else {
                            // Failed: Use demo data
                            if (batchData.errors[symbol]) {
                                console.warn(`❌ ${symbol} failed:`, batchData.errors[symbol]);
                            }
                            const fallbackData = getFallbackData(symbol);
                            companiesData.push(fallbackData);
                            fallbackCount++;
                        }
                    }
                    
                    loadingDiv.style.display = 'none';
                    renderCompaniesTable();
                    
                    if (successCount > 0) {
                        updateCompaniesStatus(`✅ Loaded! ${successCount} live, ${fallbackCount} demo (${batchData.meta.duration})`, true);
                    } else {
                        updateCompaniesStatus(`⚠️ No live data available. Using demo data for all companies.`, false);
                    }
                    return;
                }
                
                throw new Error(`Batch API failed with status ${batchResponse.status}`);
                
            } catch (batchError) {
                console.error('❌ Batch API failed:', batchError.message);
                
                // Fallback: Use demo data for all companies
                updateCompaniesStatus(`Batch API failed. Loading demo data...`, false);
                loadDemoCompaniesData();
            }
        }

        // Load companies data from Screener.in
        async function loadScreenerData() {
            if (!loadCompaniesConfig()) return;
            
            updateCompaniesStatus("Loading data from Screener.in via Vercel proxy...", true);
            
            const loadingDiv = document.getElementById('companiesLoading');
            const progressSpan = document.getElementById('loadingProgress');
            
            loadingDiv.style.display = 'block';
            companiesData = [];
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                console.log('🔍 Loading', companiesConfig.length, 'companies from Screener.in');
                
                for (let i = 0; i < companiesConfig.length; i++) {
                    const symbol = companiesConfig[i];
                    progressSpan.textContent = `Loading ${symbol}... (${i + 1}/${companiesConfig.length})`;
                    
                    try {
                        const screenerData = await fetchScreenerData(symbol);
                        companiesData.push(screenerData);
                        
                        if (screenerData.isLive) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`Error fetching ${symbol} from Screener:`, error);
                        const fallbackData = getFallbackData(symbol);
                        companiesData.push(fallbackData);
                        errorCount++;
                    }
                }
                
                loadingDiv.style.display = 'none';
                renderCompaniesTable();
                
                if (successCount > 0) {
                    updateCompaniesStatus(`✅ Screener Data Loaded! ${successCount} live, ${errorCount} fallback`, true);
                } else {
                    updateCompaniesStatus(`⚠️ No Screener data available. Using fallback data.`, false);
                }
                
            } catch (error) {
                console.error('❌ Screener loading failed:', error);
                loadingDiv.style.display = 'none';
                updateCompaniesStatus(`❌ Screener loading failed: ${error.message}`, false);
                loadDemoCompaniesData();
            }
        }

        // Fetch individual company data via Vercel API proxy
        async function fetchScreenerData(symbol) {
            try {
                console.log(`🔍 Fetching ${symbol} via Vercel API proxy`);
                
                // Use Vercel API proxy to avoid CORS issues
                const url = `/api/screener-proxy?symbol=${symbol}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ Successfully fetched ${symbol} via Vercel proxy (${response.status})`);
                    
                    if (result.success && result.data) {
                        return result.data;
                    } else {
                        throw new Error(result.error || 'Invalid response from proxy');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error(`❌ HTTP Error ${response.status} for ${symbol}:`, errorData);
                    throw new Error(`HTTP ${response.status}: ${errorData.error || response.statusText}`);
                }
                
            } catch (error) {
                console.error(`❌ Error fetching ${symbol} via Vercel proxy:`, error);
                
                if (error.message.includes('Failed to fetch')) {
                    console.log(`🌐 Network error for ${symbol}. Check internet connection.`);
                    updateCompaniesStatus(`❌ Network error for ${symbol}. Check connection and try again.`, false);
                } else {
                    updateCompaniesStatus(`❌ Error fetching ${symbol}: ${error.message}`, false);
                }
                
                return getFallbackData(symbol);
            }
        }

        // Parse Screener.in HTML to extract company data
        function parseScreenerData(symbol, html) {
            try {
                console.log(`📊 Parsing HTML for ${symbol}...`);
                
                // Create a temporary DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Helper function to extract number from text
                function extractNumber(text) {
                    if (!text) return 0;
                    const cleanText = text.replace(/[₹,%\s]/g, '').replace(/,/g, '');
                    const number = parseFloat(cleanText);
                    return isNaN(number) ? 0 : number;
                }
                
                // Helper function to find element by multiple selectors
                function findElement(selectors) {
                    for (const selector of selectors) {
                        const element = doc.querySelector(selector);
                        if (element && element.textContent.trim()) {
                            return element;
                        }
                    }
                    return null;
                }
                
                // Extract company name from multiple possible locations
                const companyNameSelectors = [
                    'h1',
                    '.company-name',
                    '.company-info h1',
                    '#main h1',
                    'title'
                ];
                const companyNameEl = findElement(companyNameSelectors);
                let companyName = symbol;
                if (companyNameEl) {
                    companyName = companyNameEl.textContent.trim()
                        .replace(' - Screener', '')
                        .replace(' Ltd.', '')
                        .replace(' Limited', '')
                        .trim();
                }
                
                // Extract current price
                const priceSelectors = [
                    '.number.price',
                    '.price .number',
                    '[data-field="current_price"]',
                    '.company-ratios .number:first-child',
                    '.top .number'
                ];
                const priceEl = findElement(priceSelectors);
                const currentPrice = priceEl ? extractNumber(priceEl.textContent) : 0;
                
                // Extract data from table rows - Screener.in uses specific structure
                const extractFromTable = (label) => {
                    const rows = doc.querySelectorAll('tr, .flex, .row');
                    for (const row of rows) {
                        const text = row.textContent.toLowerCase();
                        if (text.includes(label.toLowerCase())) {
                            const numbers = row.textContent.match(/[\d,]+\.?\d*/g);
                            if (numbers && numbers.length > 0) {
                                return extractNumber(numbers[numbers.length - 1]);
                            }
                        }
                    }
                    return 0;
                };
                
                // Extract 52-week high and low
                let high52 = extractFromTable('52w high') || extractFromTable('52 week high') || extractFromTable('high');
                let low52 = extractFromTable('52w low') || extractFromTable('52 week low') || extractFromTable('low');
                
                // Try alternative selectors for 52-week data
                if (high52 === 0) {
                    const highSelectors = [
                        '[data-field="high_52w"]',
                        '.high-52w',
                        '.number:contains("High")',
                        'td:contains("52")'
                    ];
                    const highEl = findElement(highSelectors);
                    high52 = highEl ? extractNumber(highEl.textContent) : 0;
                }
                
                if (low52 === 0) {
                    const lowSelectors = [
                        '[data-field="low_52w"]',
                        '.low-52w',
                        '.number:contains("Low")',
                        'td:contains("52")'
                    ];
                    const lowEl = findElement(lowSelectors);
                    low52 = lowEl ? extractNumber(lowEl.textContent) : 0;
                }
                
                // Extract PE ratio
                let currentPE = extractFromTable('pe') || extractFromTable('p/e') || extractFromTable('price earnings');
                
                if (currentPE === 0) {
                    const peSelectors = [
                        '[data-field="pe"]',
                        '.pe-ratio',
                        '.number:contains("PE")',
                        'td:contains("PE")'
                    ];
                    const peEl = findElement(peSelectors);
                    currentPE = peEl ? extractNumber(peEl.textContent) : 0;
                }
                
                // Extract sector information
                const sectorSelectors = [
                    '.sector',
                    '[data-field="sector"]',
                    '.company-info .sector',
                    'a[href*="sector"]',
                    '.breadcrumb a:last-child'
                ];
                const sectorEl = findElement(sectorSelectors);
                const sector = sectorEl ? sectorEl.textContent.trim() : 'Unknown';
                
                // Extract market cap
                let marketCap = extractFromTable('market cap') || extractFromTable('market capitalisation');
                
                if (marketCap === 0) {
                    const marketCapSelectors = [
                        '[data-field="market_cap"]',
                        '.market-cap',
                        '.number:contains("Cap")'
                    ];
                    const marketCapEl = findElement(marketCapSelectors);
                    if (marketCapEl) {
                        const mcText = marketCapEl.textContent.toLowerCase();
                        const mcNumber = extractNumber(mcText);
                        
                        // Convert based on suffix (Cr = Crores, L = Lakhs)
                        if (mcText.includes('cr') || mcText.includes('crore')) {
                            marketCap = mcNumber * 10000000; // Crores to actual value
                        } else if (mcText.includes('l') || mcText.includes('lakh')) {
                            marketCap = mcNumber * 100000; // Lakhs to actual value
                        } else {
                            marketCap = mcNumber;
                        }
                    }
                }
                
                // Extract change percentage
                let pChange = 0;
                const changeSelectors = [
                    '.change',
                    '[data-field="change"]',
                    '.price-change',
                    '.percent-change'
                ];
                const changeEl = findElement(changeSelectors);
                if (changeEl) {
                    const changeText = changeEl.textContent;
                    pChange = extractNumber(changeText);
                    
                    // Handle negative changes
                    if (changeText.includes('-') || changeText.includes('▼')) {
                        pChange = -Math.abs(pChange);
                    }
                }
                
                // Calculate PE at 52-week high and low
                const peAtHigh = currentPE > 0 && high52 > 0 && currentPrice > 0 ? (currentPE * high52 / currentPrice) : 0;
                const peAtLow = currentPE > 0 && low52 > 0 && currentPrice > 0 ? (currentPE * low52 / currentPrice) : 0;
                
                // Estimate sector PE (use current PE * 0.9 as approximation)
                const sectorPE = currentPE > 0 ? currentPE * 0.9 : 0;
                
                console.log(`📊 Parsed ${symbol} data:`, {
                    companyName,
                    currentPrice,
                    high52,
                    low52,
                    currentPE,
                    sector,
                    marketCap: marketCap / 10000000 + ' Cr'
                });
                
                const isValidData = currentPrice > 0 && (high52 > 0 || low52 > 0 || currentPE > 0);
                
                return {
                    symbol: symbol,
                    companyName: companyName,
                    sector: sector,
                    lastPrice: currentPrice,
                    change: 0,
                    pChange: pChange,
                    dayHigh: 0,
                    dayLow: 0,
                    weekHigh52: high52,
                    weekLow52: low52,
                    totalTradedVolume: 0,
                    marketCap: marketCap,
                    currentPE: currentPE,
                    sectorPE: sectorPE,
                    peAtHigh: peAtHigh,
                    peAtLow: peAtLow,
                                                lastUpdated: new Date().toLocaleString() + ' (📈 Screener.in via Vercel)',
                    isLive: isValidData
                };
                
            } catch (parseError) {
                console.error(`❌ Error parsing ${symbol} data:`, parseError);
                return getFallbackData(symbol);
            }
        }

        // Test single company from Screener.in via Vercel proxy
        async function testScreenerData() {
            updateCompaniesStatus("Testing Screener.in via Vercel proxy with RELIANCE...", true);
            console.log("=== SCREENER.IN VIA VERCEL PROXY TEST ===");
            
            try {
                const testData = await fetchScreenerData('RELIANCE');
                console.log("Screener.in Test Result:", testData);
                
                if (testData.isLive) {
                    updateCompaniesStatus(`✅ Vercel Proxy Success! Got data for RELIANCE (₹${testData.lastPrice})`, true);
                    
                    // Add test result to table
                    const existingIndex = companiesData.findIndex(c => c.symbol === 'RELIANCE');
                    if (existingIndex >= 0) {
                        companiesData[existingIndex] = testData;
                    } else {
                        companiesData.unshift(testData);
                    }
                    renderCompaniesTable();
                } else {
                    updateCompaniesStatus("⚠️ Vercel proxy test failed, using fallback data", false);
                }
            } catch (error) {
                console.error("Screener.in via Vercel Proxy Test Error:", error);
                updateCompaniesStatus(`❌ Vercel Proxy Error: ${error.message}`, false);
            }
        }

        // Check Vercel API proxy status
        async function checkScreenerCORS() {
            updateCompaniesStatus("Checking Vercel API proxy status...", true);
            console.log("=== VERCEL API PROXY CHECK ===");
            
            try {
                const response = await fetch('/api/screener-proxy?symbol=RELIANCE', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updateCompaniesStatus("✅ Vercel API proxy is working! Screener.in access enabled.", true);
                    console.log("✅ Vercel API Proxy Check: Working correctly");
                    
                    // Show success message
                    alert("✅ Vercel API Proxy Status: Working!\n\nScreener.in data can be accessed via proxy.\nYou can now use the 'Load Screener Data' feature.");
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    updateCompaniesStatus(`⚠️ Vercel API proxy returned HTTP ${response.status}`, false);
                    console.log("⚠️ Vercel API Proxy Check: Error", errorData);
                }
            } catch (error) {
                updateCompaniesStatus("❌ Vercel API proxy is not available", false);
                console.log("❌ Vercel API Proxy Check: Not available", error);
                
                // Show instructions for deployment
                alert("❌ Vercel API Proxy Status: Not Available\n\n" +
                      "The Vercel API proxy is not working. Please:\n\n" +
                      "1. Make sure you're accessing the deployed version\n" +
                      "2. Check that the /api/screener-proxy.js file exists\n" +
                      "3. Verify your vercel.json configuration\n" +
                      "4. Redeploy if necessary\n\n" +
                      "Alternative: Use demo data for testing.");
            }
        }

        // Render companies table
        function renderCompaniesTable() {
            console.log("renderCompaniesTable called");
            console.log("companiesData:", companiesData);
            
            const table = $('#companiesTable');
            console.log("table element found:", table.length > 0);
            
            if ($.fn.dataTable.isDataTable(table)) {
                table.DataTable().destroy();
            }
            
            const tbody = table.find('tbody')[0];
            console.log("tbody element found:", tbody ? true : false);
            
            if (!tbody) {
                console.error("Companies table tbody not found!");
                return;
            }
            
            tbody.innerHTML = companiesData.map(company => {
                const last = parseFloat(company.lastPrice);
                const high52 = parseFloat(company.weekHigh52);
                const low52 = parseFloat(company.weekLow52);
                const change = parseFloat(company.pChange);
                
                const toHigh = high52 > 0 ? (((high52 - last) / last) * 100).toFixed(2) : 0;
                const toLow = low52 > 0 ? (((last - low52) / last) * 100).toFixed(2) : 0;
                // Price Risk/Reward: Upside potential vs downside risk
                const riskReward = parseFloat(toLow) > 0 ? (parseFloat(toHigh) / parseFloat(toLow)).toFixed(2) : '∞';
                
                // PE calculations
                const currentPE = company.currentPE || 0;
                const sectorPE = company.sectorPE || 0;
                const peAtHigh = company.peAtHigh || 0;
                const peAtLow = company.peAtLow || 0;
                
                // PE Risk/Reward: How much PE can drop (reward) vs how much PE can rise (risk)
                const peRiskReward = (peAtHigh > currentPE && currentPE > peAtLow) ? 
                    ((currentPE - peAtLow) / (peAtHigh - currentPE)).toFixed(2) : 
                    (currentPE <= peAtLow ? '∞' : '0');
                
                // Helper function to get category label for risk/reward ratios
                function getRiskRewardCategory(ratio) {
                    const numRatio = parseFloat(ratio);
                    if (ratio === '∞' || numRatio >= 2.0) {
                        return { label: 'Excellent', color: '#28a745' };
                    } else if (numRatio >= 1.0) {
                        return { label: 'Good', color: '#d2691e' };
                    } else {
                        return { label: 'Poor', color: '#dc3545' };
                    }
                }
                
                // Overall Score: Composite of both price and PE risk/reward
                let overallScore = 0;
                let overallCategory = 'Poor';
                let overallColor = '#dc3545';
                
                const priceRR = parseFloat(riskReward) || 0;
                const peRR = parseFloat(peRiskReward) || 0;
                
                if (priceRR > 0 && peRR > 0 && priceRR !== Infinity && peRR !== Infinity) {
                    // Geometric mean gives balanced weight to both ratios
                    overallScore = Math.sqrt(priceRR * peRR);
                    
                    if (overallScore >= 2.0) {
                        overallCategory = 'Excellent';
                        overallColor = '#28a745';
                    } else if (overallScore >= 1.5) {
                        overallCategory = 'Good';
                        overallColor = '#d2691e';
                    } else if (overallScore >= 1.0) {
                        overallCategory = 'Average';
                        overallColor = '#007bff';
                    } else {
                        overallCategory = 'Poor';
                        overallColor = '#dc3545';
                    }
                } else if (priceRR === Infinity || peRR === Infinity) {
                    // Handle infinity cases
                    const finiteRatio = priceRR === Infinity ? peRR : priceRR;
                    if (finiteRatio >= 2.0) {
                        overallCategory = 'Very Good';
                        overallColor = '#20c997';
                        overallScore = '∞';
                    } else if (finiteRatio >= 1.0) {
                        overallCategory = 'Good';
                        overallColor = '#d2691e';
                        overallScore = '∞';
                                         } else {
                         overallCategory = 'Average';
                         overallColor = '#007bff';
                         overallScore = '∞';
                     }
                } else {
                    overallCategory = 'Poor';
                    overallColor = '#dc3545';
                    overallScore = '0';
                }
                
                let rowClass = '';
                let dataType = '';
                if (company.error) {
                    rowClass = 'error-row';
                    dataType = ' ❌';
                } else if (company.fallback) {
                    rowClass = 'fallback-row';
                    dataType = ' 📊';
                } else if (company.isLive) {
                    if (company.lastUpdated.includes('Screener.in')) {
                        rowClass = 'live-row';
                        dataType = ' 📈';
                    } else {
                        rowClass = 'live-row';
                        dataType = ' 🟢';
                    }
                } else {
                    dataType = ' 🔴';
                }
                
                // Enhanced PE calculations for value investing
                const pePremiumToSector = sectorPE > 0 ? (((currentPE - sectorPE) / sectorPE) * 100).toFixed(1) : 0;
                const peDiscountFromHigh = peAtHigh > 0 ? (((currentPE - peAtHigh) / peAtHigh) * 100).toFixed(1) : 0;
                const pePremiumFromLow = peAtLow > 0 ? (((currentPE - peAtLow) / peAtLow) * 100).toFixed(1) : 0;
                
                // Get category labels for risk/reward ratios
                const priceRRCategory = getRiskRewardCategory(riskReward);
                const peRRCategory = getRiskRewardCategory(peRiskReward);
                
                // Store the numerical overall score for sorting
                const overallScoreNumeric = typeof overallScore === 'number' ? overallScore : 
                    (overallScore === '∞' ? 999 : 0); // Assign high value to infinity for sorting
                
                return `<tr class="${rowClass}" data-overall-score="${overallScoreNumeric}">
                    <td>${company.companyName}${dataType}<br><small style="color: #666;">${company.symbol}</small></td>
                    <td><small style="color: #666;">${company.sector || 'Unknown'}</small></td>
                    <td><strong>₹${last.toLocaleString()}</strong><br><small style="color: ${change >= 0 ? 'green' : 'red'};">(${change >= 0 ? '+' : ''}${change.toFixed(2)}%)</small></td>
                    <td>₹${high52.toLocaleString()}<br><small style="color: #666;">(${((last - high52) / high52 * 100).toFixed(2)}%)</small></td>
                    <td>₹${low52.toLocaleString()}<br><small style="color: #666;">(${((last - low52) / low52 * 100).toFixed(2)}%)</small></td>
                    <td style='color: blue;'>${toHigh}%</td>
                    <td style='color: #d2691e;'>${toLow}%</td>
                    <td style='font-weight: bold; color: ${priceRRCategory.color};'>${riskReward}<br><small style="color: ${priceRRCategory.color}; font-weight: bold;">${priceRRCategory.label}</small></td>
                    <td style='font-weight: bold; color: ${peRRCategory.color};'>${peRiskReward}<br><small style="color: ${peRRCategory.color}; font-weight: bold;">${peRRCategory.label}</small></td>
                    <td style='background-color: ${overallColor}20; color: ${overallColor}; font-weight: bold; text-align: center;' data-order="${overallScoreNumeric}">${typeof overallScore === 'number' ? overallScore.toFixed(2) : overallScore}<br><small style="color: ${overallColor}; font-weight: bold;">${overallCategory}</small></td>
                    <td style='color: ${currentPE > sectorPE ? 'red' : 'green'};'>${currentPE.toFixed(2)}<br><small style="color: #666; font-weight: normal;">(${pePremiumToSector > 0 ? '+' : ''}${pePremiumToSector}% vs ${sectorPE.toFixed(2)} sector)</small></td>
                    <td style='color: red;'>${peAtHigh.toFixed(2)}<br><small style="color: #666; font-weight: normal;">(${peDiscountFromHigh > 0 ? '+' : ''}${peDiscountFromHigh}% vs high PE)</small></td>
                    <td style='color: green;'>${peAtLow.toFixed(2)}<br><small style="color: #666; font-weight: normal;">(${pePremiumFromLow > 0 ? '+' : ''}${pePremiumFromLow}% vs low PE)</small></td>
                    <td><small>${company.lastUpdated}</small></td>
                </tr>`;
            }).join('');
            
            table.DataTable({
                stateSave: true,
                pageLength: 25,
                scrollX: true,
                scrollCollapse: true,
                autoWidth: false,
                fixedHeader: false,
                order: [[9, 'desc']], // Sort by Overall Score (descending for best opportunities first)
                columnDefs: [
                    { width: "150px", targets: 0 },  // Company
                    { width: "120px", targets: 1 },  // Sector
                    { width: "130px", targets: 2 },  // Price
                    { width: "100px", targets: 3 },  // 52W High
                    { width: "100px", targets: 4 },  // 52W Low
                    { width: "110px", targets: 5 },  // To High
                    { width: "120px", targets: 6 },  // From Low
                    { width: "110px", targets: 7 },  // Price R/R
                    { width: "130px", targets: 8 },  // PE R/R
                    { width: "120px", targets: 9 },  // Score
                    { width: "100px", targets: 10 }, // Current PE
                    { width: "100px", targets: 11 }, // PE @ High
                    { width: "100px", targets: 12 }, // PE @ Low
                    { width: "140px", targets: 13 }  // Updated
                ],
                initComplete: function() {
                    // Ensure proper column alignment after initialization
                    this.api().columns.adjust().draw();
                }
            });
            
            console.log("Companies table rendered successfully with", companiesData.length, "rows");
            updateCompaniesStatus(`Table displayed with ${companiesData.length} companies`, true);
        }

        // Update status message
        function updateCompaniesStatus(message, isSuccess = true) {
            const statusElement = document.getElementById('companiesStatusText');
            const statusContainer = document.getElementById('companiesStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
            if (statusContainer) {
                statusContainer.style.background = isSuccess ? '#d1ecf1' : '#f8d7da';
                statusContainer.style.borderColor = isSuccess ? '#bee5eb' : '#f1aeb5';
            }
        }

        // Load demo data immediately for testing
        function loadDemoCompaniesData() {
            console.log("loadDemoCompaniesData called");
            console.log("companiesConfig:", companiesConfig);
            
            updateCompaniesStatus("Loading demo data...", true);
            
            companiesData = companiesConfig.map(symbol => {
                const fallback = fallbackCompanyData[symbol];
                if (fallback) {
                    // Calculate PE at 52-week high and low
                    const currentPE = fallback.currentPE || 0;
                    const peAtHigh = currentPE > 0 && fallback.weekHigh52 > 0 ? (currentPE * fallback.weekHigh52 / fallback.lastPrice) : 0;
                    const peAtLow = currentPE > 0 && fallback.weekLow52 > 0 ? (currentPE * fallback.weekLow52 / fallback.lastPrice) : 0;
                    
                    return {
                        symbol: symbol,
                        companyName: fallback.companyName,
                        sector: fallback.sector || 'Unknown',
                        lastPrice: fallback.lastPrice,
                        change: 0,
                        pChange: fallback.pChange,
                        dayHigh: 0,
                        dayLow: 0,
                        weekHigh52: fallback.weekHigh52,
                        weekLow52: fallback.weekLow52,
                        totalTradedVolume: fallback.totalTradedVolume,
                        marketCap: fallback.marketCap,
                        currentPE: currentPE,
                        sectorPE: fallback.sectorPE || 0,
                        peAtHigh: peAtHigh,
                        peAtLow: peAtLow,
                        lastUpdated: new Date().toLocaleString() + ' (Demo Data)',
                        fallback: true
                    };
                }
                return {
                    symbol: symbol,
                    companyName: symbol,
                    sector: 'Unknown',
                    lastPrice: 0,
                    pChange: 0,
                    weekHigh52: 0,
                    weekLow52: 0,
                    totalTradedVolume: 0,
                    marketCap: 0,
                    currentPE: 0,
                    sectorPE: 0,
                    peAtHigh: 0,
                    peAtLow: 0,
                    lastUpdated: new Date().toLocaleString(),
                    error: true
                };
            });
            
            console.log("companiesData created:", companiesData.length, "items");
            renderCompaniesTable();
            updateCompaniesStatus(`Demo data loaded successfully - ${companiesData.length} companies`, true);
        }

        function isValid(value) {
            return value && value !== "nil" && !isNaN(parseFloat(value.replace(/,/g, '')));
        }

        function populateFilters(data) {
            const typeSet = new Set();
            const subTypeSet = new Set();
            data.forEach(i => {
                if (i.indexType) typeSet.add(i.indexType);
                if (i.indexSubType) subTypeSet.add(i.indexSubType);
            });

            const typeSelect = document.getElementById("indexTypeFilter");
            const subTypeSelect = document.getElementById("indexSubTypeFilter");

            if (typeSelect) {
                for (let i = typeSelect.options.length - 1; i > 0; i--) {
                    typeSelect.remove(i);
                }
                [...typeSet].sort().forEach(type => {
                    const opt = document.createElement("option");
                    opt.value = type;
                    opt.textContent = type;
                    typeSelect.appendChild(opt);
                });
            }

            if (subTypeSelect) {
                for (let i = subTypeSelect.options.length - 1; i > 0; i--) {
                    subTypeSelect.remove(i);
                }
                [...subTypeSet].sort().forEach(sub => {
                    const opt = document.createElement("option");
                    opt.value = sub;
                    opt.textContent = sub;
                    subTypeSelect.appendChild(opt);
                });
            }
        }

        function renderTable(data, tableId) {
            const table = $(`#${tableId}`);
            if (!table.length) return;
            if ($.fn.dataTable.isDataTable(table)) {
                table.DataTable().destroy();
            }
            const tbody = table.find("tbody")[0];
            if (!tbody) return;
            tbody.innerHTML = data.map(index => {
                const last = parseFloat(index.last.replace(/,/g, ''));
                const high = parseFloat(index.yearHigh.replace(/,/g, ''));
                const low = parseFloat(index.yearLow.replace(/,/g, ''));
                const change = parseFloat(index.percChange);
                const toHigh = (((high - last) / last) * 100).toFixed(2);
                const toLow = (((last - low) / last) * 100).toFixed(2);
                const riskReward = parseFloat(toLow) > 0 ? (parseFloat(toHigh) / parseFloat(toLow)).toFixed(2) : '∞';
                return `<tr>
                    <td><strong>${index.indexName}</strong></td>
                    <td>${index.last}</td>
                    <td style="color: ${change >= 0 ? 'green' : 'red'}; font-weight: bold;">${change}%</td>
                    <td>${index.yearHigh} <br><small style="color: #666;">(${((last - high) / high * 100).toFixed(2)}%)</small></td>
                    <td>${index.yearLow} <br><small style="color: #666;">(${((last - low) / low * 100).toFixed(2)}%)</small></td>
                    <td style='color: blue; font-weight: bold;'>${toHigh}%</td>
                    <td style='color: #d2691e; font-weight: bold;'>${toLow}%</td>
                    <td style='font-weight: bold;'>${riskReward}</td>
                    <td><small>${index.timeVal}</small></td>
                </tr>`;
            }).join('');
            table.DataTable({ 
                stateSave: true,
                pageLength: 10,
                responsive: true,
                scrollX: true,
                autoWidth: false,
                order: [[1, 'desc']]
            });
        }

        async function fetchAndRender() {
            try {
                document.getElementById("errorMsg").style.display = "none";
                const timestamp = Date.now();
                const res = await fetch(`https://iislliveblob.niftyindices.com/jsonfiles/LiveIndicesWatch.json?_=${timestamp}`);
                if (!res.ok) throw new Error("Response not OK");
                const json = await res.json();
                const fullData = json.data;

                populateFilters(fullData);

                const selectedType = document.getElementById("indexTypeFilter").value || "all";
                const selectedSubType = document.getElementById("indexSubTypeFilter").value || "all";

                const filteredAll = fullData.filter(i =>
                    isValid(i.yearHigh) &&
                    isValid(i.yearLow) &&
                    isValid(i.last) &&
                    (selectedType === "all" || i.indexType === selectedType) &&
                    (selectedSubType === "all" || i.indexSubType === selectedSubType)
                );

                renderTable(filteredAll.filter(i =>
                    ["NIFTY 50", "NIFTY NEXT 50", "NIFTY MIDCAP 150", "NIFTY SMALLCAP 250", "NIFTY MICROCAP250"].includes(i.indexName)
                ), "topIndicesTable");

                renderTable(filteredAll.filter(i =>
                    ["NIFTY BANK", "NIFTY IT", "NIFTY AUTO"].includes(i.indexName)
                ), "sectorIndicesTable");

                renderTable(filteredAll, "allIndicesTable");

            } catch (err) {
                console.error("Fetch error", err);
                document.getElementById("errorMsg").style.display = "block";
                populateFilters(fallbackData);
                renderTable(fallbackData.filter(i =>
                    ["NIFTY 50", "NIFTY NEXT 50", "NIFTY MIDCAP 150", "NIFTY SMALLCAP 250", "NIFTY MICROCAP250"].includes(i.indexName)
                ), "topIndicesTable");
                renderTable(fallbackData.filter(i =>
                    ["NIFTY BANK", "NIFTY IT", "NIFTY AUTO"].includes(i.indexName)
                ), "sectorIndicesTable");
                renderTable(fallbackData, "allIndicesTable");
            }
        }

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById("refreshInterval").value || 60000);
            console.log("Starting auto refresh with interval:", interval);
            clearInterval(window.intervalId);
            
            if (document.getElementById("autoRefreshToggle").checked) {
                window.intervalId = setInterval(() => {
                    console.log("Auto refresh triggered");
                    fetchAndRender();
                }, interval);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchAndRender();
            
            // Event listeners
            document.getElementById("refreshInterval").addEventListener("change", function() {
                console.log("Refresh interval changed to:", this.value);
                startAutoRefresh();
            });
            
            document.getElementById("autoRefreshToggle").addEventListener("change", function() {
                console.log("Auto refresh toggled:", this.checked);
                if (this.checked) {
                    fetchAndRender();
                    startAutoRefresh();
                } else {
                    clearInterval(window.intervalId);
                }
            });
            
            document.getElementById("indexTypeFilter").addEventListener("change", fetchAndRender);
            document.getElementById("indexSubTypeFilter").addEventListener("change", fetchAndRender);
            
            // Initialize companies tab
            const autoLoadLive = document.getElementById('autoLoadLiveData');
            if (autoLoadLive && autoLoadLive.checked) {
                console.log("Auto-loading live companies data...");
                loadCompaniesData();
            } else {
                console.log("Loading demo companies data...");
                loadDemoCompaniesData();
                console.log("Demo companies data loaded, count:", companiesData.length);
            }
            
            // Start auto refresh
            startAutoRefresh();
        });
    </script>
</body>
</html>
